<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>ELK | ru0</title><meta name="description" content="ELK - ruo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="ru0"></head><body><div class="wrap"><header><h1 class="branding"><a href="/" title="ru0"><img class="logo-image" src="/logo.png" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="/mind" target="_self">HACKMIND</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/ru0" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">ELK</h1><div class="post-info"><a></a>2019-03-19</div><div class="post-content"><h2 id="指南"><a href="#指南" class="headerlink" title="指南"></a>指南</h2><p><a href="https://elkguide.elasticsearch.cn/logstash/get-start/install.html" target="_blank" rel="external">https://elkguide.elasticsearch.cn/logstash/get-start/install.html</a></p>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p>Elasticsearch 实时全文搜索和分析引擎<br>Logstash 日志收集，分析，过滤<br>Kibana 数据图形化展示</p>
<p><img src="http://static.open-open.com/news/uploadImg/20150716/20150716205233_183.png" alt=""></p>
<p>Server（producer） Beats  -&gt; Zookeeper Kafka topic -&gt; (按照业务功能拆分ELK cluster) Logstash (consumer) -&gt; ES -&gt; Kibana (日志敏感信息泄露)</p>
<p>服务器<br>/etc/hosts<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">30.3.229.120    develk01</div><div class="line">30.3.229.121    develk02</div><div class="line">30.3.229.122    develk03</div><div class="line">30.3.229.123    devkafka01</div><div class="line">30.3.229.124    devkafka02</div><div class="line">30.3.229.125    devkafka03</div></pre></td></tr></table></figure></p>
<p>添加root用户<br>useradd -u 0 -o -g root -G root -d /root/ user1<br>echo “user1”:”passw0rD” | chpasswd</p>
<a id="more"></a>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>升级java至1.8</p>
<p>卸载低版本java<br>rpm -qa | grep jdk<br>yum -y remove jdk-1.7.0_79-fcs.x86_64<br>yum -y list java*<br>yum -y install java-1.8.0-openjdk.x86_64<br>rpm -i jdk-8u171-linux-x64.rpm<br>rpm -qa | grep logstash<br>rpm -e –nodeps logstash-5.6.10-1.noarch</p>
<p>版本选择</p>
<p>Beats<br>Elasticsearch<br>Elasticsearch Hadoop<br>Kibana<br>Logstash<br>X-Pack</p>
<h3 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h3><p>/etc/elasticsearch/elasticsearch.yml                            # els的配置文件<br>/etc/elasticsearch/jvm.options                                  # JVM相关的配置，内存大小等等<br>/etc/elasticsearch/log4j2.properties                            # 日志系统定义<br>/var/lib/elasticsearch                                          # 数据的默认存放位置</p>
<p>集群配置</p>
<p>/etc/elasticsearch/elasticsearch.yml </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">cluster.name: elk-cluster</div><div class="line">node.name: $&#123;HOSTNAME&#125;</div><div class="line">#node.master: true</div><div class="line">#node.data: true</div><div class="line">network.host: 0.0.0.0</div><div class="line">http.port: 9200</div><div class="line">path.data: /data/els/data</div><div class="line">path.logs: /data/els/logs</div><div class="line">bootstrap.memory_lock: false</div><div class="line">bootstrap.system_call_filter: false</div><div class="line">network.host: 0.0.0.0</div><div class="line">http.port: 9200</div><div class="line">discovery.zen.ping.unicast.hosts: [&quot;devekl01&quot;, &quot;develk02&quot;,&quot;develk03&quot;]</div><div class="line">discovery.zen.minimum_master_nodes: 2</div></pre></td></tr></table></figure>
<p>/etc/security/limits.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">* soft nofile 65536</div><div class="line">* hard nofile 65536</div></pre></td></tr></table></figure>
<p>启动报错</p>
<p>Java HotSpot(TM) 64-Bit Server VM warning: INFO: os::commit_memory(0x0000000085330000, 2060255232, 0) failed; error=’Cannot allocate memory’ (errno=12)</p>
<p>/etc/elasticsearch/jvm.options</p>
<p>-Xms512m<br>-Xmx512m</p>
<p>[2]: max number of threads [1832] for user [elasticsearch] is too low, increase to at least [2048]</p>
<p>ulimit -u 2048</p>
<p>创建数据目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">rm -rf /data/</div><div class="line">mkdir -p /data/els/&#123;logs,data&#125;</div><div class="line">chown -R elasticsearch.elasticsearch /data/*</div><div class="line">service elasticsearch start`</div><div class="line">or</div><div class="line">bin/elasticsearch -d</div></pre></td></tr></table></figure></p>
<p>查看节点</p>
<p><a href="http://30.3.229.120:9200/_cat/nodes?pretty" target="_blank" rel="external">http://30.3.229.120:9200/_cat/nodes?pretty</a></p>
<h4 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h4><p>查看索引<br><code>curl http://localhost:9200/_cat/indices?v</code></p>
<p>删除索引<br><code>curl -u elastic:changeme -XDELETE http://localhost:9200/my_index</code></p>
<p>/_cat/health?v<br>/_cat/nodes?v </p>
<p>安装x-pack<br><code>bin/elasticsearch-plugin install x-pack</code></p>
<p>修改x-pack默认密码<br><code>curl -XPUT -u elastic &#39;localhost:9200/_xpack/security/user/elastic/_password&#39; -d &#39;{&quot;password&quot; : &quot;dfh*&amp;(dUJ&quot;}&#39;</code></p>
<h4 id="elasticsearch-head-监控"><a href="#elasticsearch-head-监控" class="headerlink" title="elasticsearch-head 监控"></a>elasticsearch-head 监控</h4><p>yum install nodejs<br>yum install npm<br>npm install -g grunt-cli<br>git config –global https.proxy <a href="http://127.0.0.1:1080" target="_blank" rel="external">http://127.0.0.1:1080</a><br>git clone git://github.com/mobz/elasticsearch-head.git<br>npm config set strict-ssl false<br>npm config set registry <a href="https://registry.npm.taobao.org" target="_blank" rel="external">https://registry.npm.taobao.org</a><br>npm config set proxy <a href="http://127.0.0.1:1080" target="_blank" rel="external">http://127.0.0.1:1080</a><br>npm info express<br>npm install<br>grunt server</p>
<p>后台运行<br>nohup grunt server &amp;</p>
<p><a href="http://localhost:9100" target="_blank" rel="external">http://localhost:9100</a></p>
<h3 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[logstash-5.x]</div><div class="line">name=Elastic repository for 5.x packages</div><div class="line">baseurl=https://artifacts.elastic.co/packages/5.x/yum</div><div class="line">gpgcheck=1</div><div class="line">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</div><div class="line">enabled=1</div><div class="line">autorefresh=1</div><div class="line">type=rpm-md</div></pre></td></tr></table></figure>
<p>/etc/logstash/conf.d/elk.conf</p>
<p>input –&gt; filter –&gt; output</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">  syslog &#123;</div><div class="line">    syslog_field =&gt; &quot;syslog&quot; # default message</div><div class="line">    port =&gt; 514</div><div class="line">  &#125;</div><div class="line">  beats &#123;</div><div class="line">    port =&gt; 5044</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">filter &#123;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">  elasticsearch &#123;</div><div class="line">    hosts =&gt; [&quot;192.168.200.109:9200&quot;]</div><div class="line">    index =&gt; &quot;test-%&#123;+YYYY.MM&#125;&quot; </div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>启动logstash<br><code>nohup bin/logstash --debug --path.settings /etc/logstash/ -f config/test.conf &gt; ls.log 2&gt;&amp;1 &amp;</code><br>多实例<br>bin/logstash -f config/syslog.conf –path.data=/tmp</p>
<p><a href="https://www.elastic.co/guide/en/logstash/5.6/config-examples.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/5.6/config-examples.html</a></p>
<p>写入kafka<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">	stdin&#123;&#125;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">    kafka &#123;</div><div class="line">      topic_id =&gt; &quot;test&quot;</div><div class="line">      codec =&gt; plain &#123;</div><div class="line">            format =&gt; &quot;%&#123;message&#125;&quot;</div><div class="line">            charset =&gt; &quot;UTF-8&quot;</div><div class="line">      &#125;</div><div class="line">      bootstrap_servers =&gt; &quot;192.168.6.22:9092&quot;</div><div class="line">    &#125;</div><div class="line">    stdout&#123;</div><div class="line">        codec =&gt; rubydebug</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>读取kafka<br>区别于低版本，5.0后的版本连接kafka实例地址，而非zk。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">input&#123;</div><div class="line">    kafka&#123;</div><div class="line">        bootstrap_servers =&gt; [&quot;192.168.6.22:9092&quot;]</div><div class="line">        #client_id =&gt; &quot;test&quot;</div><div class="line">        group_id =&gt; &quot;test&quot;</div><div class="line">        auto_offset_reset =&gt; &quot;latest&quot;</div><div class="line">        consumer_threads =&gt; 5</div><div class="line">        decorate_events =&gt; true</div><div class="line">        topics =&gt; [&quot;test&quot;]</div><div class="line">     &#125;</div><div class="line">&#125;</div><div class="line">output&#123;</div><div class="line">	elasticsearch &#123; </div><div class="line">		hosts =&gt; [&quot;127.0.0.1:9200&quot;] </div><div class="line">		index =&gt; &quot;test-%&#123;+YYYY.MM&#125;&quot;</div><div class="line">		user =&gt; &apos;elastic&apos;</div><div class="line">		password =&gt; &apos;changeme&apos;</div><div class="line">	</div><div class="line">	&#125;</div><div class="line">    stdout&#123;</div><div class="line">        codec =&gt; rubydebug</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>多进程</p>
<p>bin/logstash -f config/rsyslog.conf –path.data=/tmp</p>
<p>安装x-pack监控<br>logstash-plugin install file:///tmp/x-pack-5.6.10.zip</p>
<p>nano config/logstash.yml </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">xpack.monitoring.elasticsearch.url: [&quot;http://10.2.0.27:9200&quot;] </div><div class="line">xpack.monitoring.elasticsearch.username: &quot;elastic&quot; </div><div class="line">xpack.monitoring.elasticsearch.password: &quot;dfh*&amp;(dUJ&quot;</div><div class="line">xpack.monitoring.enabled: true</div><div class="line">xpack.monitoring.collection.interval: 10s</div></pre></td></tr></table></figure>
<h3 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h3><p>Topic<br>Kafka将消息种子(Feed)分门别类 每一类的消息称之为话题(Topic).<br>Producer<br>发布消息的对象称之为话题生产者(Kafka topic producer)<br>Consumer<br>订阅消息并处理发布的消息的种子的对象称之为话题消费者(consumers)<br>Broker<br>已发布的消息保存在一组服务器中称之为Kafka集群。集群中的每一个服务器都是一个代理(Broker). 消费者可以订阅一个或多个话题并从Broker拉数据从而消费这些已发布的消息。</p>
<p>由于broker采用了主题topic–&gt;分区的思想，使得某个分区内部的顺序可以保证有序性，但是分区间的数据不保证有序性。这样，消费者可以以分区为单位，自定义读取的位置——offset。</p>
<p>兼容性<br>如果使用logstash 5.x 则相应的kafka版本选择0.10.0.x<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># |==========================================================</div><div class="line"># |Kafka Client Version |Logstash Version |Plugin Version |Why?</div><div class="line"># |0.8                  |2.0.0 - 2.x.x    |&lt;3.0.0         |Legacy, 0.8 is still popular </div><div class="line"># |0.9                  |2.0.0 - 2.3.x    | 3.x.x         |Works with the old Ruby Event API (`event[&apos;product&apos;][&apos;price&apos;] = 10`)  </div><div class="line"># |0.9                  |2.4.x - 5.x.x    | 4.x.x         |Works with the new getter/setter APIs (`event.set(&apos;[product][price]&apos;, 10)`)</div><div class="line"># |0.10.0.x             |2.4.x - 5.x.x    | 5.x.x         |Not compatible with the &lt;= 0.9 broker</div><div class="line"># |==========================================================</div></pre></td></tr></table></figure></p>
<p>wget <a href="http://mirrors.hust.edu.cn/apache/kafka/0.11.0.2/kafka-0.11.0.2-src.tgz" target="_blank" rel="external">http://mirrors.hust.edu.cn/apache/kafka/0.11.0.2/kafka-0.11.0.2-src.tgz</a></p>
<p>配置 server.properties<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">broker.id=0</div><div class="line">listeners=PLAINTEXT://kafka01:9092</div><div class="line">advertised.listeners=PLAINTEXT://kafka01:9092</div></pre></td></tr></table></figure></p>
<p>修改启动脚本jvm内存使用大小<br><code>export KAFKA_HEAP_OPTS=&quot;-Xmx512M -Xms256M&quot;</code></p>
<p>启动服务<br><code>nohup bin/zookeeper-server-start.sh config/zookeeper.properties &gt; zk.out 2&gt;&amp;1 &amp;</code><br><code>nohup bin/kafka-server-start.sh config/server.properties &gt; kafka.out 2&gt;&amp;1 &amp;</code></p>
<p><code>bin/kafka-server-start.sh -daemon config/server.properties</code></p>
<p>自动创建topoic<br><code>bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test</code></p>
<p>查看已创建的topic<br><code>bin/kafka-topics.sh --list  --zookeeper localhost:2181</code></p>
<p>查看test topic详情<br><code>bin/kafka-topics.sh --describe --zookeeper localhost:2181  --topic test</code></p>
<p>删除topic<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">bin/kafka-topics.sh --delete --zookeeper localhost:2181 --topic test # 标记删除</div><div class="line">bin/zookeeper-shell.sh localhost:2181 # zk 删除</div><div class="line">ls /brokers/topics</div><div class="line">rmr /brokers/topics/test</div></pre></td></tr></table></figure></p>
<blockquote>
<p>或者修改server.properties文件参数delete.topic.enable=true</p>
</blockquote>
<p>测试</p>
<p>生产者<br><code>bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test</code></p>
<p>消费者<br><code>bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic test --from-beginning</code></p>
<blockquote>
<p>生产者消费者机器必须写kafka主机名hosts</p>
</blockquote>
<h4 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h4><p>zookeeper.properties<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/tmp/zookeeper</div><div class="line">clientPort=2181</div><div class="line">maxClientCnxns=0</div><div class="line">server.0=kafka:2888:3888</div><div class="line">server.1=kafka01:2889:3889</div><div class="line">server.2=kafka02:2890:3890</div></pre></td></tr></table></figure></p>
<p>在dataDir目录设置各自的id<br><code>mkdir -p /tmp/zookeeper/log &amp;&amp; echo [server.id] &gt; /tmp/zookeeper/myid</code></p>
<p>server.properties<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">broker.id=0 # 配置不同的id</div><div class="line">listeners=PLAINTEXT://kafka:9092</div><div class="line">advertised.listeners=PLAINTEXT://kafka:9092</div><div class="line">zookeeper.connect=kafka:2181,kafka01:2181,kafka02:2181</div></pre></td></tr></table></figure></p>
<p>测试</p>
<p>创建topic并向任意broker写入消息，从任意broker读取消息。</p>
<p>创建Topic<br><code>bin/kafka-topics.sh --create --zookeeper devkafka01:2181,devkafka02:2181,devkafka03:2181 --replication-factor 3 --partition 3 --topic mytopic</code></p>
<p>列出topic<br><code>bin/kafka-topics.sh --list --zookeeper localhost:2181</code></p>
<p>查看Topic<br><code>bin/kafka-topics.sh --describe --zookeeper devkafka01:2181 --topic mytopic</code></p>
<p>创建生产者<br><code>bin/kafka-console-producer.sh --broker-list devkafka01:9092,devkafka02:9092,devkafka03:9092 --topic mytopic</code></p>
<p>创建消费者<br><code>bin/kafka-console-consumer.sh --zookeeper devkafka01:2181,devkafka02:2181,devkafka03:2181 --from-beginning --topic mytopic</code></p>
<h4 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">java -cp KafkaOffsetMonitor-assembly-0.3.0-SNAPSHOT.jar \</div><div class="line">com.quantifind.kafka.offsetapp.OffsetGetterWeb \</div><div class="line">--offsetStorage kafka \</div><div class="line">--zk devkafka01,devkafka02,devkafka03 \</div><div class="line">--port 8080 \</div><div class="line">--refresh 10.seconds \</div><div class="line">--retain 1.days</div></pre></td></tr></table></figure>
<p>nohup ./kom.sh &gt; /dev/null 2&gt;&amp;1 &amp;</p>
<h4 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h4><h3 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h3><p>/etc/kibana/kibana.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server.port: 5601  # kibana 监听端口</div><div class="line">server.host: 0.0.0.0  # 监听ip</div><div class="line">elasticsearch.url: &quot;http://127.0.0.1:9200&quot;  # es主节点</div><div class="line">elasticsearch.username: &quot;elastic&quot;</div><div class="line">elasticsearch.password: &quot;changeme&quot;</div></pre></td></tr></table></figure>
<p>离线安装x-pack</p>
<p><code>bin/kibana-plugin install file:///tmp/x-pack-5.6.10.zip</code></p>
<p>service kibana start<br>or<br>nohup bin/kibana &amp;</p>
<h3 id="图表"><a href="#图表" class="headerlink" title="图表"></a>图表</h3><p>告警类型饼图<br>攻击源地址柱状图<br>访问的url信息</p>
<h3 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h3><h3 id="Beats"><a href="#Beats" class="headerlink" title="Beats"></a>Beats</h3><p>Winlogbeat 5.6.10</p>
<p>配置<br>winlogbeat.yml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#----------------------------- Logstash output --------------------------------</div><div class="line">output.logstash:</div><div class="line">  # The Logstash hosts</div><div class="line">  hosts: [&quot;192.168.200.109:5044&quot;]</div><div class="line">  </div><div class="line">#--------------------------kafka-----------------------------------</div><div class="line">output.kafka:</div><div class="line">  # initial brokers for reading cluster metadata</div><div class="line">  hosts: [&quot;192.168.6.22:9092&quot;]</div><div class="line">  topic: &quot;test&quot;</div></pre></td></tr></table></figure></p>
<p>Logstash<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">  beats &#123;</div><div class="line">    port =&gt; 5044</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>检查配置<br><code>.\winlogbeat.exe -c .\winlogbeat.yml -configtest -e</code></p>
<p>安装<br><code>PS C:\winlogbeat-5.6.10-windows-x86_64&gt; .\install-service-winlogbeat.ps1</code><br>启动服务<br><code>net start winlogbeat</code></p>
<h3 id="Flume"><a href="#Flume" class="headerlink" title="Flume"></a>Flume</h3><h3 id="X-Pack"><a href="#X-Pack" class="headerlink" title="X-Pack"></a>X-Pack</h3><p>默认密码<br>username: elastic<br>password: changeme</p>
<p>破解</p>
<p>LicenseVerifier.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">package org.elasticsearch.license;</div><div class="line"></div><div class="line">import java.nio.*;</div><div class="line">import java.util.*;</div><div class="line">import java.security.*;</div><div class="line">import org.elasticsearch.common.xcontent.*;</div><div class="line">import org.apache.lucene.util.*;</div><div class="line">import org.elasticsearch.common.io.*;</div><div class="line">import java.io.*;</div><div class="line"></div><div class="line">public class LicenseVerifier</div><div class="line">&#123;</div><div class="line">    public static boolean verifyLicense(final License license, final byte[] encryptedPublicKeyData) &#123;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static boolean verifyLicense(final License license) &#123;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>javac -cp &quot;/usr/share/elasticsearch/lib/elasticsearch-5.6.10.jar:/usr/share/elasticsearch/lib/lucene-core-6.6.1.jar:/usr/share/elasticsearch/plugins/x-pack/x-pack-5.6.10.jar&quot; LicenseVerifier.java</code></p>
<p>注册新的license<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;license&quot;:&#123;&quot;uid&quot;:&quot;d3cbbbee-9155-4e1a-a5ed-a7e8940d6564&quot;,&quot;type&quot;:&quot;platinum&quot;,&quot;issue_date_in_millis&quot;:1499299200000,&quot;expiry_date_in_millis&quot;:2524579200999,&quot;max_nodes&quot;:1000,&quot;issued_to&quot;:&quot;guo dalu (eastmoney)&quot;,&quot;issuer&quot;:&quot;Web Form&quot;,&quot;signature&quot;:&quot;AAAAAwAAAA0C9L3AjL50eKgiW55YAAABmC9ZN0hjZDBGYnVyRXpCOW5Bb3FjZDAxOWpSbTVoMVZwUzRxVk1PSmkxaktJRVl5MUYvUWh3bHZVUTllbXNPbzBUemtnbWpBbmlWRmRZb25KNFlBR2x0TXc2K2p1Y1VtMG1UQU9TRGZVSGRwaEJGUjE3bXd3LzRqZ05iLzRteWFNekdxRGpIYlFwYkJiNUs0U1hTVlJKNVlXekMrSlVUdFIvV0FNeWdOYnlESDc3MWhlY3hSQmdKSjJ2ZTcvYlBFOHhPQlV3ZHdDQ0tHcG5uOElCaDJ4K1hob29xSG85N0kvTWV3THhlQk9NL01VMFRjNDZpZEVXeUtUMXIyMlIveFpJUkk2WUdveEZaME9XWitGUi9WNTZVQW1FMG1DenhZU0ZmeXlZakVEMjZFT2NvOWxpZGlqVmlHNC8rWVVUYzMwRGVySHpIdURzKzFiRDl4TmM1TUp2VTBOUlJZUlAyV0ZVL2kvVk10L0NsbXNFYVZwT3NSU082dFNNa2prQ0ZsclZ4NTltbU1CVE5lR09Bck93V2J1Y3c9PQAAAQB2gL4WXN64P0+c5q6TDyhqPllFvkboZMWjzJHid05qCtI86/I0aSsFgYF3AkVA1qoz7UHsjC/xBsoyhuXfmHn6LbsZYXweZ4LsllG8RJ8HH/bBYVTBt+Mag+wXE/QZUS7HnSA8iAReQ7tY//wyuEVrxFDeAI9cgwWN90RoZ3sAgkzGq0jVr2JoUYeYwNJ4GZ2GMDS7GsHBxNWBJVgfDkZXvLya/jOJhaKi2GvW8mIzFp19/FO+t2+ReUkbF3T35nVIZnqFDVhXtOz981By4ArffE8ythlI4X67Nabtzoy87V5gXanBvsSdHiHpYJMrYwn7DU+93Ie6t56Lesjkj//b&quot;,&quot;start_date_in_millis&quot;:1499299200000&#125;&#125;</div></pre></td></tr></table></figure></p>
<p><code>curl -XPUT -u elastic:changeme &#39;http://30.3.229.120:9200/_xpack/license?acknowledge=true&#39; -d @l.json</code><br><code>curl -XGET -u elastic:changeme &#39;http://30.3.229.120:9200/_license&#39;</code></p>
<h4 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h4><p>监控含有alert的日志并发送邮件告警</p>
<p>配置elasticsearch.yml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">xpack.notification.email.account:</div><div class="line">    exchange_account:</div><div class="line">        profile: outlook</div><div class="line">        email_defaults:</div><div class="line">            from: user@domain.com</div><div class="line">        smtp:</div><div class="line">            auth: true</div><div class="line">            starttls.enable: false</div><div class="line">            host: mail.domain.com   </div><div class="line">            port: 587</div><div class="line">            user: user</div><div class="line">            password: pass</div></pre></td></tr></table></figure></p>
<p>“event_type”: “alert”,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;trigger&quot;: &#123;</div><div class="line">	// 每间隔5m触发</div><div class="line">    &quot;schedule&quot;: &#123;</div><div class="line">      &quot;interval&quot;: &quot;5m&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;input&quot;: &#123;</div><div class="line">	// 查询结果</div><div class="line">    &quot;search&quot;: &#123;</div><div class="line">      &quot;request&quot;: &#123;</div><div class="line">        &quot;search_type&quot;: &quot;query_then_fetch&quot;,</div><div class="line">        &quot;indices&quot;: [&quot;logstash-map-2018.07&quot;],</div><div class="line">        &quot;types&quot;: [],</div><div class="line">        &quot;body&quot;: &#123;</div><div class="line">          &quot;size&quot;: 0,</div><div class="line">          &quot;query&quot;: &#123;</div><div class="line">            // bool 同时满足两个条件</div><div class="line">			&quot;bool&quot; : &#123;</div><div class="line">		      &quot;must&quot; : [</div><div class="line">		        &#123; &quot;match&quot; : &#123; &quot;event_type&quot;: &quot;alert&quot; &#125;&#125;,</div><div class="line">		        &#123; &quot;range&quot; : &#123; &quot;@timestamp&quot; : &#123; &quot;gte&quot; : &quot;now-1h&quot; &#125;&#125;&#125;</div><div class="line">		      ]</div><div class="line">		    &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  // 判断acction条件</div><div class="line">  &quot;condition&quot;: &#123;</div><div class="line">    &quot;compare&quot;: &#123;</div><div class="line">      &quot;ctx.payload.hits.total&quot;: &#123;</div><div class="line">        &quot;gte&quot;: 10</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  // 执行告警方式</div><div class="line">  &quot;actions&quot;: &#123;</div><div class="line">    &quot;my-logging-action&quot;: &#123;</div><div class="line">      &quot;logging&quot;: &#123;</div><div class="line">        &quot;level&quot;: &quot;info&quot;,</div><div class="line">        &quot;text&quot;: &quot;Fine &#123;&#123;ctx.payload.hits.total&#125;&#125; alerts in last 5m.&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>聚合5m钟内登陆失败用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">GET logstash-dc01-security-2018.08/_search</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 1,</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot; : &#123;</div><div class="line">      &quot;must&quot; : [&#123; &quot;match&quot; : &#123; &quot;event_id&quot; : 4625 &#125;&#125;],</div><div class="line">	  &quot;filter&quot;:[&#123; &quot;range&quot; : &#123; &quot;@timestamp&quot; : &#123; &quot;gte&quot; : &quot;now-1d&quot; &#125;&#125;&#125;]</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;group_by_TargetUserName&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;event_data.TargetUserName.keyword&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Result：</div><div class="line"></div><div class="line">&quot;aggregations&quot;: &#123;</div><div class="line">  &quot;group_by_TargetUserName&quot;: &#123;</div><div class="line">    &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">    &quot;sum_other_doc_count&quot;: 0,</div><div class="line">    &quot;buckets&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;doc_count&quot;: 6,</div><div class="line">        &quot;key&quot;: &quot;test&quot;</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        &quot;doc_count&quot;: 2,</div><div class="line">        &quot;key&quot;: &quot;test1&quot;</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        &quot;doc_count&quot;: 1,</div><div class="line">        &quot;key&quot;: &quot;admin&quot;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>数组<br>ctx.payload.aggregations.group_by_TargetUserName.buckets</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&quot;condition&quot;: &#123;</div><div class="line">  &quot;array_compare&quot;: &#123;</div><div class="line">    &quot;ctx.payload.aggregations.group_by_TargetUserName.buckets&quot; : &#123; </div><div class="line">      &quot;path&quot;: &quot;doc_count&quot; ,</div><div class="line">      &quot;gte&quot;: &#123; </div><div class="line">        &quot;value&quot;: 25, </div><div class="line">        &quot;quantifier&quot;: &quot;some&quot; </div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>动作</p>
<p>发送邮件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&quot;send_email&quot; : &#123;</div><div class="line">&quot;throttle_period&quot;: &quot;15m&quot;,</div><div class="line">  &quot;email&quot; : &#123;</div><div class="line">    &quot;to&quot; : &quot;&lt;username&gt;@&lt;domainname&gt;&quot;, </div><div class="line">	&quot;cc&quot;: [&quot;a@&lt;domainname&gt;&quot;,&quot;b@&lt;domainname&gt;&quot;]</div><div class="line">    &quot;subject&quot; : &quot;Watcher Notification&quot;, </div><div class="line">    &quot;body&quot; : &quot;Top10 users:\n&#123;&#123;#ctx.payload.aggregations.topn.buckets&#125;&#125;\n&#123;&#123;key&#125;&#125; &#123;&#123;doc_count&#125;&#125;\n&#123;&#123;/ctx.payload.aggregations.topn.buckets&#125;&#125;&quot;,</div><div class="line">	&quot;attachments&quot; : &#123;</div><div class="line">      &quot;attached_data&quot; : &#123;</div><div class="line">        &quot;data&quot; : &#123;</div><div class="line">          &quot;format&quot; : &quot;json&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;priority&quot; : &quot;high&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>webhook</p>
<h3 id="Suricata"><a href="#Suricata" class="headerlink" title="Suricata"></a>Suricata</h3><p><a href="https://suricata-ids.org/" target="_blank" rel="external">https://suricata-ids.org/</a></p>
<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">sudo yum -y install gcc libpcap-devel pcre-devel libyaml-devel file-devel \</div><div class="line">  zlib-devel jansson-devel nss-devel libcap-ng-devel libnet-devel tar make \</div><div class="line">  libnetfilter_queue-devel lua-devel</div><div class="line">wget https://www.openinfosecfoundation.org/download/suricata-4.0.4.tar.gz</div><div class="line">tar -zxvf suricata-4.0.4.tar.gz</div><div class="line">cd suricata-4.0.4</div><div class="line">./configure --prefix=/usr --sysconfdir=/etc --localstatedir=/var --enable-nfqueue --enable-lua</div><div class="line">make &amp; make install</div><div class="line">make install-full</div></pre></td></tr></table></figure>
<p>suricata -c /etc/suricata/suricata.yaml -i eth1</p>
<h4 id="更新规则"><a href="#更新规则" class="headerlink" title="更新规则"></a>更新规则</h4><p>pip install suricata-update </p>
<p>规则源<br><a href="https://www.openinfosecfoundation.org/rules/index.yaml" target="_blank" rel="external">https://www.openinfosecfoundation.org/rules/index.yaml</a></p>
<p>et/open: <a href="https://rules.emergingthreats.net/open/suricata-%(__version__)s/emerging.rules.tar.gz" target="_blank" rel="external">https://rules.emergingthreats.net/open/suricata-%(__version__)s/emerging.rules.tar.gz</a><br>et/pro: <a href="https://rules.emergingthreatspro.com/%(secret-code)s/suricata-%(__version__)s/etpro.rules.tar.gz" target="_blank" rel="external">https://rules.emergingthreatspro.com/%(secret-code)s/suricata-%(__version__)s/etpro.rules.tar.gz</a><br>oisf/trafficid: <a href="https://raw.githubusercontent.com/jasonish/suricata-trafficid/master/rules/traffic-id.rules" target="_blank" rel="external">https://raw.githubusercontent.com/jasonish/suricata-trafficid/master/rules/traffic-id.rules</a><br>ptresearch/attackdetection: <a href="https://raw.githubusercontent.com/ptresearch/AttackDetection/master/pt.rules.tar.gz" target="_blank" rel="external">https://raw.githubusercontent.com/ptresearch/AttackDetection/master/pt.rules.tar.gz</a><br>scwx/malware: <a href="https://ws.secureworks.com/ti/ruleset/%(secret-code)s/Suricata_suricata-malware_latest.tgz" target="_blank" rel="external">https://ws.secureworks.com/ti/ruleset/%(secret-code)s/Suricata_suricata-malware_latest.tgz</a><br>scwx/security: <a href="https://ws.secureworks.com/ti/ruleset/59af35658a44c415/Suricata_suricata-security_latest.tgz" target="_blank" rel="external">https://ws.secureworks.com/ti/ruleset/59af35658a44c415/Suricata_suricata-security_latest.tgz</a><br>sslbl/ssl-fp-blacklist: <a href="https://sslbl.abuse.ch/blacklist/sslblacklist.rules" target="_blank" rel="external">https://sslbl.abuse.ch/blacklist/sslblacklist.rules</a></p>
<h2 id="日志采集"><a href="#日志采集" class="headerlink" title="日志采集"></a>日志采集</h2><h3 id="Syslog"><a href="#Syslog" class="headerlink" title="Syslog"></a>Syslog</h3><p>syslog日志格式</p>
<p>WAF</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    syslog &#123;</div><div class="line">        timezone =&gt; &quot;Asia/Shanghai&quot;</div><div class="line">        id =&gt; &quot;my_plugin_id&quot;</div><div class="line">        port =&gt; 514</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">filter &#123;</div><div class="line">    # drop waf_log_wafstat</div><div class="line">    if [severity] == 6 &#123;</div><div class="line">        drop &#123; &#125;</div><div class="line">    &#125;</div><div class="line">    # waf log</div><div class="line">    if [severity] == 3 &#123;</div><div class="line">        grok &#123;</div><div class="line">            match =&gt; &#123; &quot;message&quot; =&gt; &quot;tag:%&#123;DATA:tag&#125;\s*site_id:%&#123;INT:site_id&#125;\s*protect_id:%&#123;INT:protect_id&#125;\s*dst_ip:%&#123;IPORHOST:dst_ip&#125;\s*dst_port:%&#123;INT:dst_port&#125;\s*src_ip:%&#123;IPORHOST:src_ip&#125;\s*src_port:%&#123;INT:src_port&#125;\s*method:%&#123;DATA:method&#125;\s*domain:%&#123;DATA:domain&#125;\s*uri:%&#123;DATA:uri&#125;\s*alertlevel:%&#123;DATA:alert_level&#125;\s*event_type:%&#123;DATA:event_type&#125;\s*stat_time:%&#123;TIMESTAMP_ISO8601:stat_time&#125;\s*policy_id:%&#123;INT:policy_id&#125;\s*rule_id:%&#123;INT:rule_id&#125;\s*action:%&#123;DATA:action&#125;\s*block:%&#123;DATA:block&#125;\s*block_info:%&#123;DATA:block_info&#125;\s*http:%&#123;DATA:http&#125;\s*alertinfo:%&#123;DATA:alertinfo&#125;\s*proxy_info:%&#123;DATA:proxy_info&#125;\s*characters:%&#123;DATA:characters&#125;\s*count_num:%&#123;INT:count_num&#125;\s*protocol_type:%&#123;DATA:protocol_type&#125;\s*wci:%&#123;DATA:wci&#125;\s*wsi:%&#123;DATA:wsi&#125;\s*country:%&#123;DATA:country&#125;&quot;&#125;</div><div class="line">        &#125;</div><div class="line">        mutate &#123;</div><div class="line">            remove_field =&gt; [&quot;message&quot;]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">    elasticsearch &#123;</div><div class="line">        hosts =&gt; [&quot;http://develk01:9200&quot;,&quot;http://develk02:9200&quot;,&quot;http://develk03:9200&quot;]</div><div class="line">        user =&gt; &quot;elastic&quot;</div><div class="line">        password =&gt; &quot;changeme&quot;</div><div class="line">        index =&gt; &quot;waf-cs-syslog-217&quot;</div><div class="line">    &#125;</div><div class="line">    stdout &#123; codec =&gt; rubydebug &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="sysmon"><a href="#sysmon" class="headerlink" title="sysmon"></a>sysmon</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">	beats &#123;</div><div class="line">		port =&gt; 5044</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">filter&#123;</div><div class="line">	mutate &#123;  </div><div class="line">		split =&gt; [&quot;message&quot;,&quot;\r&quot;]</div><div class="line">		remove_field =&gt; [&quot;message&quot;,&quot;beat&quot;,&quot;@version&quot;]</div><div class="line">		lowercase =&gt; [&quot;host&quot;] # index must be lower case</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&quot;source_name&quot; =&gt; &quot;Microsoft-Windows-Security-Auditing&quot;</div><div class="line">&quot;Microsoft-Windows-Sysmon&quot;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">	</div><div class="line">	elasticsearch &#123;</div><div class="line">        hosts =&gt; [&quot;http://develk01:9200&quot;]</div><div class="line">        index =&gt; &quot;logstash-%&#123;[host]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div></article></div></main><footer><div class="paginator"><a class="next" href="/2018/05/11/Password-Crack-Tips/">next</a></div><div class="copyright"><p>&copy; 2019 <a href="http://ruos.org">ruo</a>.<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/Dreyer/hexo-theme-artemis" target="_blank">Artemis</a>.</p></div></footer></div></body></html>